# è£œåŠ©é‡‘ãƒ»åŠ©æˆé‡‘ è‡ªå‹•ãƒãƒƒãƒãƒ³ã‚°ï¼†ç”³è«‹æ›¸ä½œæˆæ”¯æ´ã‚·ã‚¹ãƒ†ãƒ 

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦

- **Name**: subsidy-matching (hojyokin)
- **Version**: 1.3.0 (S3 å£æ‰“ã¡ãƒãƒ£ãƒƒãƒˆ + S4 ç”³è«‹æ›¸ãƒ‰ãƒ©ãƒ•ãƒˆ å®Œäº†)
- **Goal**: ä¼æ¥­æƒ…å ±ã‚’ç™»éŒ²ã™ã‚‹ã ã‘ã§ã€æœ€é©ãªè£œåŠ©é‡‘ãƒ»åŠ©æˆé‡‘ã‚’è‡ªå‹•ã§ãƒãƒƒãƒãƒ³ã‚°ï¼†ç”³è«‹æ›¸ãƒ‰ãƒ©ãƒ•ãƒˆä½œæˆ

### è¨­è¨ˆæ€æƒ³

> **ã€Œè£œåŠ©é‡‘ã‚’"é€šã™"ãƒ„ãƒ¼ãƒ«ã€ã§ã¯ãªãã€Œè£œåŠ©é‡‘ã§äººç”Ÿã‚’å£Šã•ã›ãªã„ãƒ„ãƒ¼ãƒ«ã€**

- æ¡æŠã‚ˆã‚Šå®Œèµ°
- é‡‘é¡ã‚ˆã‚Šå®‰å…¨
- è‡ªå‹•åŒ–ã‚ˆã‚Šåˆ¤æ–­è£œåŠ©

---

## URLs

### æœ¬ç•ªç’°å¢ƒ (Cloudflare Pages)

| ãƒšãƒ¼ã‚¸ | URL | èª¬æ˜ |
|--------|-----|------|
| ãƒˆãƒƒãƒ— | https://hojyokin.pages.dev | ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚° |
| ãƒ­ã‚°ã‚¤ãƒ³ | https://hojyokin.pages.dev/login | èªè¨¼ |
| æ–°è¦ç™»éŒ² | https://hojyokin.pages.dev/register | ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ |
| ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ | https://hojyokin.pages.dev/dashboard | ãƒ¡ã‚¤ãƒ³ç”»é¢ |
| ä¼šç¤¾æƒ…å ± | https://hojyokin.pages.dev/company | ä¼æ¥­ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›† |
| è£œåŠ©é‡‘ä¸€è¦§ | https://hojyokin.pages.dev/subsidies | è£œåŠ©é‡‘æ¤œç´¢ |
| è£œåŠ©é‡‘è©³ç´° | https://hojyokin.pages.dev/subsidies/:id | å€‹åˆ¥è£œåŠ©é‡‘æƒ…å ± |
| å£æ‰“ã¡ãƒãƒ£ãƒƒãƒˆ | https://hojyokin.pages.dev/chat?session_id=XXX | S3: äº‹å‰åˆ¤å®šï¼‹ä¸è¶³æƒ…å ±åé›† |
| ç”³è«‹æ›¸ãƒ‰ãƒ©ãƒ•ãƒˆ | https://hojyokin.pages.dev/draft?session_id=XXX | S4: ç”³è«‹æ›¸ä½œæˆ |
| ç®¡ç†ç”»é¢ | https://hojyokin.pages.dev/admin | ç®¡ç†è€…ç”¨ |

### é–‹ç™ºç’°å¢ƒ

- **GitHub**: https://github.com/matiuskuma2/hojyokin
- **Sandbox**: PM2 + wrangler pages dev (port 3000)

---

## ã‚·ã‚¹ãƒ†ãƒ ãƒ•ãƒ­ãƒ¼ï¼ˆS1ã€œS4ï¼‰

```
[ä¼šç¤¾æƒ…å ±ç™»éŒ²]
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  S1: è£œåŠ©é‡‘æ¤œç´¢  /subsidies                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ä¼æ¥­æƒ…å ±ï¼ˆæ¥­ç¨®ãƒ»è¦æ¨¡ãƒ»åœ°åŸŸï¼‰ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°                  â”‚ â”‚
â”‚  â”‚ â†’ å½“ã¦ã¯ã¾ã‚‹ã‚‚ã®å„ªå…ˆè¡¨ç¤º / å…¨ä»¶è¡¨ç¤º åˆ‡æ›¿                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  S2: è£œåŠ©é‡‘è©³ç´°  /subsidies/:id                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ åˆ¶åº¦æ¦‚è¦ãƒ»ç”³è«‹è¦ä»¶ãƒ»ç· åˆ‡ãƒ»è£œåŠ©ç‡ ç­‰                           â”‚ â”‚
â”‚  â”‚ â†’ [å£æ‰“ã¡ã‚’é–‹å§‹] ãƒœã‚¿ãƒ³                                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  S3: å£æ‰“ã¡ãƒãƒ£ãƒƒãƒˆ  /chat?subsidy_id=XXX&company_id=YYY          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 1. äº‹å‰åˆ¤å®š (precheck)                                        â”‚ â”‚
â”‚  â”‚    - NG: ç”³è«‹ä¸å¯ç†ç”±ã‚’è¡¨ç¤º â†’ çµ‚äº†                            â”‚ â”‚
â”‚  â”‚    - OK: ç”³è«‹å¯èƒ½ â†’ S4ã¸                                      â”‚ â”‚
â”‚  â”‚    - OK_WITH_MISSING: ä¸è¶³æƒ…å ±ã‚ã‚Š â†’ è³ªå•é–‹å§‹                 â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚ 2. ä¸è¶³æƒ…å ±åé›†ï¼ˆå£æ‰“ã¡ï¼‰                                     â”‚ â”‚
â”‚  â”‚    - ã‚·ã‚¹ãƒ†ãƒ ãŒè³ªå• â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå›ç­”                          â”‚ â”‚
â”‚  â”‚    - å›ç­”ã¯ chat_facts ã«ä¿å­˜ï¼ˆæ¬¡å›ä»¥é™èã‹ãªã„ï¼‰             â”‚ â”‚
â”‚  â”‚    - å…¨è³ªå•å®Œäº† â†’ S4ã¸                                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  S4: ç”³è«‹æ›¸ãƒ‰ãƒ©ãƒ•ãƒˆ  /draft?session_id=XXX                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 1. ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”Ÿæˆ                                           â”‚ â”‚
â”‚  â”‚    - 5ã‚»ã‚¯ã‚·ãƒ§ãƒ³: èƒŒæ™¯ãƒ»èª²é¡Œ / äº‹æ¥­ç›®çš„ / å®Ÿæ–½å†…å®¹ãƒ»æ–¹æ³•      â”‚ â”‚
â”‚  â”‚                   / å®Ÿæ–½ä½“åˆ¶ / è³‡é‡‘è¨ˆç”»ï¼ˆæ¦‚è¦ï¼‰                â”‚ â”‚
â”‚  â”‚    - æ ¹æ‹ : company_profile + chat_facts + subsidy_info        â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚ 2. NGãƒ•ã‚£ãƒ«ã‚¿ãƒã‚§ãƒƒã‚¯                                         â”‚ â”‚
â”‚  â”‚    - æ–­å®šè¡¨ç¾ãƒ»ä¸æ­£ç¤ºå”†ãƒ»ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹é•å ã‚’è­¦å‘Š          â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚ 3. ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç·¨é›† â†’ ä¿å­˜ â†’ ç¢ºå®š                               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
    [å®Œäº†]
```

---

## ãƒ‡ãƒ¼ã‚¿ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ãƒ‡ãƒ¼ã‚¿ã®å½¹å‰²åˆ†æ‹…

| å½¹å‰² | ãƒ†ãƒ¼ãƒ–ãƒ« | èª¬æ˜ |
|------|----------|------|
| åŸºæœ¬æƒ…å ± | companies + company_profile | æ¤œç´¢å‰ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆå½“ã¦ã¯ã¾ã‚‹ã‹å¦ã‹ï¼‰ |
| æ›¸é¡ | company_documents | è‡ªå‹•å…¥åŠ›ãƒ»è£å–ã‚Šç”¨ï¼ˆOCRæŠ½å‡ºäºˆå®šï¼‰ |
| å‰ææ¡ä»¶ | eligibility_rules | precheckåˆ¤å®šãƒ«ãƒ¼ãƒ« |
| å£æ‰“ã¡å›ç­” | chat_facts | ã€Œæ¬¡å›ä»¥é™èã‹ãªã„ã€è³‡ç”£ |
| ä¼šè©±ãƒ­ã‚° | chat_messages | UIè¡¨ç¤ºãƒ»ç›£æŸ»ç”¨ |
| ç”³è«‹æ›¸ | application_drafts | ãƒ‰ãƒ©ãƒ•ãƒˆãƒ»ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç† |

### ä¸»è¦ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§

| ãƒ†ãƒ¼ãƒ–ãƒ« | èª¬æ˜ |
|----------|------|
| `users` | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ |
| `companies` | ä¼šç¤¾åŸºæœ¬æƒ…å ± |
| `company_profile` | ä¼šç¤¾è©³ç´°ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« |
| `company_documents` | ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ›¸é¡ |
| `subsidy_cache` | è£œåŠ©é‡‘ã‚­ãƒ£ãƒƒã‚·ãƒ¥ |
| `eligibility_rules` | é©æ ¼æ€§åˆ¤å®šãƒ«ãƒ¼ãƒ« |
| `chat_sessions` | å£æ‰“ã¡ã‚»ãƒƒã‚·ãƒ§ãƒ³ |
| `chat_messages` | ãƒãƒ£ãƒƒãƒˆå±¥æ­´ |
| `chat_facts` | åé›†æ¸ˆã¿äº‹å®Ÿ |
| `application_drafts` | ç”³è«‹æ›¸ãƒ‰ãƒ©ãƒ•ãƒˆ |
| `source_registry` | 47éƒ½é“åºœçœŒã‚¯ãƒ­ãƒ¼ãƒ«å°å¸³ |
| `crawl_queue` | Cronã‚­ãƒ¥ãƒ¼ |
| `subsidy_lifecycle` | åˆ¶åº¦ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ« |

---

## API Endpoints

### èªè¨¼ API

| Endpoint | Method | èª¬æ˜ |
|----------|--------|------|
| `/api/auth/register` | POST | ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ² |
| `/api/auth/login` | POST | ãƒ­ã‚°ã‚¤ãƒ³ |
| `/api/auth/refresh` | POST | ãƒˆãƒ¼ã‚¯ãƒ³ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ |
| `/api/auth/forgot-password` | POST | ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆç”³è«‹ |
| `/api/auth/reset-password` | POST | ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œ |

### ä¼šç¤¾æƒ…å ± API

| Endpoint | Method | èª¬æ˜ |
|----------|--------|------|
| `/api/companies` | GET | ä¼šç¤¾ä¸€è¦§ |
| `/api/companies` | POST | ä¼šç¤¾ä½œæˆ |
| `/api/companies/:id` | GET | ä¼šç¤¾è©³ç´° |
| `/api/companies/:id` | PUT | ä¼šç¤¾æ›´æ–° |
| `/api/profile` | GET | ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«çµ±åˆå–å¾— |
| `/api/profile` | PUT | ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–° |
| `/api/profile/completeness` | GET | å®Œæˆåº¦å–å¾— |
| `/api/profile/documents` | POST | æ›¸é¡ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ |
| `/api/profile/documents` | GET | æ›¸é¡ä¸€è¦§ |
| `/api/profile/documents/:id` | DELETE | æ›¸é¡å‰Šé™¤ |

### è£œåŠ©é‡‘ API

| Endpoint | Method | èª¬æ˜ |
|----------|--------|------|
| `/api/subsidies` | GET | è£œåŠ©é‡‘æ¤œç´¢ |
| `/api/subsidies/:id` | GET | è£œåŠ©é‡‘è©³ç´° |

### S3: å£æ‰“ã¡ãƒãƒ£ãƒƒãƒˆ API

| Endpoint | Method | èª¬æ˜ |
|----------|--------|------|
| `/api/chat/precheck` | POST | äº‹å‰åˆ¤å®š |
| `/api/chat/sessions` | POST | ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ |
| `/api/chat/sessions` | GET | ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ |
| `/api/chat/sessions/:id` | GET | ã‚»ãƒƒã‚·ãƒ§ãƒ³è©³ç´° |
| `/api/chat/sessions/:id/message` | POST | ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ |

### S4: ç”³è«‹æ›¸ãƒ‰ãƒ©ãƒ•ãƒˆ API

| Endpoint | Method | èª¬æ˜ |
|----------|--------|------|
| `/api/draft/generate` | POST | ãƒ‰ãƒ©ãƒ•ãƒˆç”Ÿæˆ |
| `/api/draft/:id` | GET | ãƒ‰ãƒ©ãƒ•ãƒˆå–å¾— |
| `/api/draft/:id` | PUT | ãƒ‰ãƒ©ãƒ•ãƒˆæ›´æ–° |
| `/api/draft/:id/check-ng` | POST | NGãƒã‚§ãƒƒã‚¯å†å®Ÿè¡Œ |
| `/api/draft/:id/finalize` | POST | ãƒ‰ãƒ©ãƒ•ãƒˆç¢ºå®š |

### ãƒŠãƒ¬ãƒƒã‚¸ API (K1/K2)

| Endpoint | Method | èª¬æ˜ |
|----------|--------|------|
| `/api/knowledge/crawl/:urlId` | POST | URLå˜ä½“ã‚¯ãƒ­ãƒ¼ãƒ« |
| `/api/knowledge/extract/:urlId` | POST | ExtractæŠ½å‡º |
| `/api/knowledge/registry` | GET | source_registryä¸€è¦§ |
| `/api/knowledge/stats` | GET | ãƒŠãƒ¬ãƒƒã‚¸çµ±è¨ˆ |

### Consumer API

| Endpoint | Method | èª¬æ˜ |
|----------|--------|------|
| `/api/consumer/run` | POST | ã‚­ãƒ¥ãƒ¼ã‚¸ãƒ§ãƒ–å‡¦ç† |
| `/api/consumer/status` | GET | ã‚­ãƒ¥ãƒ¼çŠ¶æ…‹ |
| `/api/consumer/requeue/:id` | POST | å†ã‚­ãƒ¥ãƒ¼ |
| `/api/consumer/cleanup` | DELETE | å¤ã„ã‚¸ãƒ§ãƒ–å‰Šé™¤ |

---

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Cloudflare (Phase K2 + S3/S4)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Pages (hojyokin)                                          â”‚  â”‚
â”‚  â”‚ - èªè¨¼ (JWT + PBKDF2)                                     â”‚  â”‚
â”‚  â”‚ - ä¼æ¥­CRUD + Profile                                      â”‚  â”‚
â”‚  â”‚ - è£œåŠ©é‡‘æ¤œç´¢ (JGrants API)                                â”‚  â”‚
â”‚  â”‚ - S3: å£æ‰“ã¡ãƒãƒ£ãƒƒãƒˆ (precheck + factsåé›†)               â”‚  â”‚
â”‚  â”‚ - S4: ç”³è«‹æ›¸ãƒ‰ãƒ©ãƒ•ãƒˆ (ãƒ†ãƒ³ãƒ—ãƒ¬ç”Ÿæˆ + NGãƒ•ã‚£ãƒ«ã‚¿)          â”‚  â”‚
â”‚  â”‚ - ãƒŠãƒ¬ãƒƒã‚¸ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ (K1/K2)                            â”‚  â”‚
â”‚  â”‚ - Consumer (crawl_queueå‡¦ç†)                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Cron Worker (hojyokin-cron)                              â”‚  â”‚
â”‚  â”‚ - scheduled: æ¯æ—¥03:00 JST                                â”‚  â”‚
â”‚  â”‚ - dueæŠ½å‡º â†’ crawl_queueæŠ•å…¥                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚     D1      â”‚ â”‚     R2      â”‚ â”‚   Firecrawl â”‚              â”‚
â”‚  â”‚ (SQLite)    â”‚ â”‚ (knowledge) â”‚ â”‚   (Scrape)  â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å®Ÿè£…æ¸ˆã¿æ©Ÿèƒ½ âœ…

### Phase 1-A (CloudflareåŸºç›¤)
- [x] èªè¨¼ (JWT + PBKDF2)
- [x] ä¼æ¥­CRUD
- [x] JGrants Adapter (live/mock/cached-only)
- [x] ä¸€æ¬¡ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°
- [x] D1ã‚­ãƒ£ãƒƒã‚·ãƒ¥

### Phase K1 (ãƒŠãƒ¬ãƒƒã‚¸åé›†)
- [x] Firecrawl scrape â†’ R2 rawä¿å­˜
- [x] source_urlç®¡ç†
- [x] content_hashå·®åˆ†æ¤œçŸ¥

### Phase K2 (å·®åˆ†æ›´æ–°)
- [x] Extract Schema v1 (Firecrawl v2 API)
- [x] 47éƒ½é“åºœçœŒå°å¸³ (source_registry)
- [x] Cron Worker (dueæŠ½å‡º â†’ crawl_queueæŠ•å…¥)
- [x] Consumer (crawl_queueå‡¦ç†)
- [x] domain_policy (è‡ªå‹•ãƒ–ãƒ­ãƒƒã‚¯)

### S3: å£æ‰“ã¡ãƒãƒ£ãƒƒãƒˆ âœ…
- [x] POST /api/chat/precheckï¼ˆäº‹å‰åˆ¤å®š: NG/OK/OK_WITH_MISSINGï¼‰
- [x] POST /api/chat/sessionsï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆï¼‹åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰
- [x] GET /api/chat/sessionsï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ï¼‰
- [x] GET /api/chat/sessions/:idï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³è©³ç´°ï¼‰
- [x] POST /api/chat/sessions/:id/messageï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ï¼‹factsä¿å­˜ï¼‰
- [x] /chat UIï¼ˆãƒ—ãƒ¬ãƒã‚§ãƒƒã‚¯è¡¨ç¤ºã€è³ªå•å¿œç­”ã€ã‚¯ã‚¤ãƒƒã‚¯å›ç­”ï¼‰
- [x] chat_sessions / chat_messages / chat_facts ãƒ†ãƒ¼ãƒ–ãƒ«
- [x] /subsidies/:id â†’ /chat å°ç·šæ¥ç¶š

### S4: ç”³è«‹æ›¸ãƒ‰ãƒ©ãƒ•ãƒˆ âœ…
- [x] POST /api/draft/generateï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ï¼‹å¤‰æ•°åŸ‹ã‚è¾¼ã¿ç”Ÿæˆï¼‰
- [x] GET /api/draft/:idï¼ˆãƒ‰ãƒ©ãƒ•ãƒˆå–å¾—ï¼‰
- [x] PUT /api/draft/:idï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³æ›´æ–°ï¼‹NGå†è©•ä¾¡ï¼‰
- [x] POST /api/draft/:id/check-ngï¼ˆNGãƒã‚§ãƒƒã‚¯å†å®Ÿè¡Œï¼‰
- [x] POST /api/draft/:id/finalizeï¼ˆãƒ‰ãƒ©ãƒ•ãƒˆç¢ºå®šï¼‰
- [x] /draft UIï¼ˆ5ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç·¨é›†ã€NGãƒã‚§ãƒƒã‚¯ã€è‡ªå‹•ä¿å­˜ã€ç¢ºå®šï¼‰
- [x] application_drafts ãƒ†ãƒ¼ãƒ–ãƒ«
- [x] /chat å®Œäº† â†’ /draft å°ç·šæ¥ç¶š
- [x] NGãƒ•ã‚£ãƒ«ã‚¿ãƒ«ãƒ¼ãƒ«ï¼ˆæ–­å®šè¡¨ç¾ãƒ»ä¸æ­£ç¤ºå”†ãƒ»ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ï¼‰

---

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ— ğŸ“‹

### Phase 2 (å„ªå…ˆ)
1. **æ›¸é¡ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ â†’ è‡ªå‹•å…¥åŠ›**
   - OCR/LLMæŠ½å‡º â†’ extracted_json
   - company_profile ã¸ã®è‡ªå‹•åæ˜ 
   
2. **LLMãƒ–ãƒ©ãƒƒã‚·ãƒ¥ã‚¢ãƒƒãƒ—**
   - mode=llm ã§ãƒ‰ãƒ©ãƒ•ãƒˆæ–‡ç« ã‚’è‡ªç„¶åŒ–
   
3. **PDFå‡ºåŠ›**
   - ç¢ºå®šãƒ‰ãƒ©ãƒ•ãƒˆã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

### æ©Ÿèƒ½æ‹¡å¼µ
- [ ] æ¤œç´¢ã®ã€Œå½“ã¦ã¯ã¾ã‚‹ã‚‚ã®å„ªå…ˆã€ãƒˆã‚°ãƒ«
- [ ] NGè‡ªå‹•å·®ã—æ›¿ãˆææ¡ˆ
- [ ] åŠ ç‚¹è¦ç´ ã®è¡¨ç¤ºï¼ˆbonus_*ï¼‰
- [ ] ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®š

---

## é–‹ç™ºç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

```bash
# ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
cd /home/user/webapp
npm install

# D1ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ (ãƒ­ãƒ¼ã‚«ãƒ«)
npx wrangler d1 migrations apply subsidy-matching-production --local

# ãƒ“ãƒ«ãƒ‰
npm run build

# é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•
pm2 start ecosystem.config.cjs

# API ãƒ†ã‚¹ãƒˆ
curl http://localhost:3000/api/health
```

### E2Eãƒ†ã‚¹ãƒˆ

```bash
# ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ² â†’ ä¼šç¤¾ä½œæˆ â†’ ãƒãƒ£ãƒƒãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ â†’ ãƒ‰ãƒ©ãƒ•ãƒˆç”Ÿæˆ
TOKEN=$(curl -s http://localhost:3000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"Test1234!","name":"ãƒ†ã‚¹ãƒˆ"}' \
  | jq -r '.data.token')

# ä¼šç¤¾ä½œæˆ
COMPANY_ID=$(curl -s http://localhost:3000/api/companies \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"name":"ãƒ†ã‚¹ãƒˆæ ªå¼ä¼šç¤¾","prefecture":"æ±äº¬éƒ½","industry_major":"G","employee_count":10}' \
  | jq -r '.data.id')

# ãƒãƒ£ãƒƒãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
SESSION_ID=$(curl -s http://localhost:3000/api/chat/sessions \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"subsidy_id":"test-subsidy-001","company_id":"'$COMPANY_ID'"}' \
  | jq -r '.data.session.id')

# ãƒ‰ãƒ©ãƒ•ãƒˆç”Ÿæˆ
curl -s http://localhost:3000/api/draft/generate \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"session_id":"'$SESSION_ID'","mode":"template"}'
```

---

## ç’°å¢ƒå¤‰æ•°

### Cloudflare (.dev.vars)
```
JWT_SECRET=your-secret-key-32-chars-minimum
JWT_ISSUER=subsidy-app
JWT_AUDIENCE=subsidy-app-users
JGRANTS_MODE=mock
FIRECRAWL_API_KEY=fc-xxx
```

---

## ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«

| ãƒ•ã‚¡ã‚¤ãƒ« | èª¬æ˜ |
|----------|------|
| 0001_initial_schema.sql | åŸºæœ¬ã‚¹ã‚­ãƒ¼ãƒ |
| 0002_eligibility_rules.sql | é©æ ¼æ€§ãƒ«ãƒ¼ãƒ« |
| 0003_knowledge_pipeline.sql | ãƒŠãƒ¬ãƒƒã‚¸ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ |
| ... | ... |
| 0015_company_profile.sql | ä¼šç¤¾ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ‹¡å¼µ |
| 0016_s3_s4_chat_draft.sql | S3/S4: ãƒãƒ£ãƒƒãƒˆï¼‹ãƒ‰ãƒ©ãƒ•ãƒˆ |

---

## ãƒ©ã‚¤ã‚»ãƒ³ã‚¹

Private

## æ›´æ–°å±¥æ­´

- **2026-01-22**: S4 ç”³è«‹æ›¸ãƒ‰ãƒ©ãƒ•ãƒˆç”Ÿæˆ å®Œäº†
- **2026-01-22**: S3 å£æ‰“ã¡ãƒãƒ£ãƒƒãƒˆ å®Œäº†
- **2026-01-21**: Phase K2 Cron + Consumerå®Ÿè£…å®Œäº†
- **2026-01-21**: 47éƒ½é“åºœçœŒå°å¸³æŠ•å…¥
- **2026-01-21**: Extract Schema v1å®Ÿè£…
- **2026-01-21**: Phase 1-Aå®Œäº†ã€Phase 2 AWSè¨­è¨ˆå®Œäº†
