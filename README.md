# è£œåŠ©é‡‘ãƒ»åŠ©æˆé‡‘ è‡ªå‹•ãƒãƒƒãƒãƒ³ã‚°ï¼†ç”³è«‹æ›¸ä½œæˆæ”¯æ´ã‚·ã‚¹ãƒ†ãƒ 

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦

- **Name**: subsidy-matching (hojyokin)
- **Version**: 1.4.0 (Phase 1: æ›¸é¡è‡ªå‹•æŠ½å‡ºæ©Ÿèƒ½)
- **Goal**: ä¼æ¥­æƒ…å ±ã‚’ç™»éŒ²ã™ã‚‹ã ã‘ã§ã€æœ€é©ãªè£œåŠ©é‡‘ãƒ»åŠ©æˆé‡‘ã‚’è‡ªå‹•ã§ãƒãƒƒãƒãƒ³ã‚°ï¼†ç”³è«‹æ›¸ãƒ‰ãƒ©ãƒ•ãƒˆä½œæˆ

### æœ€æ–°ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ (v1.4.0) - Phase 1: æ›¸é¡è‡ªå‹•å…¥åŠ›

**æ›¸é¡ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ â†’ è‡ªå‹•æƒ…å ±æŠ½å‡º â†’ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«åæ˜ **

ç™»è¨˜ç°¿è¬„æœ¬ã‚„æ±ºç®—æ›¸ã‚’PDFã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€è‡ªå‹•çš„ã«ä¼šç¤¾æƒ…å ±ã‚’æŠ½å‡ºã—ã€ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã«åæ˜ ã§ãã¾ã™ã€‚

- `/company` ç”»é¢ã®ã€Œæ›¸é¡ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã€ã‚¿ãƒ–
- å¯¾å¿œæ›¸é¡: ç™»è¨˜ç°¿è¬„æœ¬ï¼ˆå±¥æ­´äº‹é …å…¨éƒ¨è¨¼æ˜æ›¸ï¼‰ã€æ±ºç®—æ›¸ãƒ»è²¡å‹™è«¸è¡¨
- PDF.jsã«ã‚ˆã‚‹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡º
- æ­£è¦è¡¨ç¾ãƒ™ãƒ¼ã‚¹ã®æƒ…å ±ãƒ‘ãƒ¼ã‚·ãƒ³ã‚°ï¼ˆå•†å·ã€ä½æ‰€ã€è³‡æœ¬é‡‘ã€è¨­ç«‹æ—¥ã€ä»£è¡¨è€…åãªã©ï¼‰
- æŠ½å‡ºçµæœã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼†ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«åæ˜ æ©Ÿèƒ½

### è¨­è¨ˆæ€æƒ³

> **ã€Œè£œåŠ©é‡‘ã‚’"é€šã™"ãƒ„ãƒ¼ãƒ«ã€ã§ã¯ãªãã€Œè£œåŠ©é‡‘ã§äººç”Ÿã‚’å£Šã•ã›ãªã„ãƒ„ãƒ¼ãƒ«ã€**

- æ¡æŠã‚ˆã‚Šå®Œèµ°
- é‡‘é¡ã‚ˆã‚Šå®‰å…¨
- è‡ªå‹•åŒ–ã‚ˆã‚Šåˆ¤æ–­è£œåŠ©

---

## URLs

### æœ¬ç•ªç’°å¢ƒ (Cloudflare Pages)

| ãƒšãƒ¼ã‚¸ | URL | èª¬æ˜ |
|--------|-----|------|
| ãƒˆãƒƒãƒ— | https://hojyokin.pages.dev | ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚° |
| ãƒ­ã‚°ã‚¤ãƒ³ | https://hojyokin.pages.dev/login | èªè¨¼ |
| æ–°è¦ç™»éŒ² | https://hojyokin.pages.dev/register | ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ |
| ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ | https://hojyokin.pages.dev/dashboard | ãƒ¡ã‚¤ãƒ³ç”»é¢ |
| ä¼šç¤¾æƒ…å ± | https://hojyokin.pages.dev/company | ä¼æ¥­ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›† |
| è£œåŠ©é‡‘ä¸€è¦§ | https://hojyokin.pages.dev/subsidies | è£œåŠ©é‡‘æ¤œç´¢ |
| è£œåŠ©é‡‘è©³ç´° | https://hojyokin.pages.dev/subsidies/:id | å€‹åˆ¥è£œåŠ©é‡‘æƒ…å ± |
| å£æ‰“ã¡ãƒãƒ£ãƒƒãƒˆ | https://hojyokin.pages.dev/chat?session_id=XXX | S3: äº‹å‰åˆ¤å®šï¼‹ä¸è¶³æƒ…å ±åé›† |
| ç”³è«‹æ›¸ãƒ‰ãƒ©ãƒ•ãƒˆ | https://hojyokin.pages.dev/draft?session_id=XXX | S4: ç”³è«‹æ›¸ä½œæˆ |
| ç®¡ç†ç”»é¢ | https://hojyokin.pages.dev/admin | ç®¡ç†è€…ç”¨ |

### é–‹ç™ºç’°å¢ƒ

- **GitHub**: https://github.com/matiuskuma2/hojyokin
- **Sandbox**: PM2 + wrangler pages dev (port 3000)

---

## ã‚·ã‚¹ãƒ†ãƒ ãƒ•ãƒ­ãƒ¼ï¼ˆS1ã€œS4ï¼‰

```
[ä¼šç¤¾æƒ…å ±ç™»éŒ²]
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  S1: è£œåŠ©é‡‘æ¤œç´¢  /subsidies                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ä¼æ¥­æƒ…å ±ï¼ˆæ¥­ç¨®ãƒ»è¦æ¨¡ãƒ»åœ°åŸŸï¼‰ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°                  â”‚ â”‚
â”‚  â”‚ â†’ å½“ã¦ã¯ã¾ã‚‹ã‚‚ã®å„ªå…ˆè¡¨ç¤º / å…¨ä»¶è¡¨ç¤º åˆ‡æ›¿                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  S2: è£œåŠ©é‡‘è©³ç´°  /subsidies/:id                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ åˆ¶åº¦æ¦‚è¦ãƒ»ç”³è«‹è¦ä»¶ãƒ»ç· åˆ‡ãƒ»è£œåŠ©ç‡ ç­‰                           â”‚ â”‚
â”‚  â”‚ â†’ [å£æ‰“ã¡ã‚’é–‹å§‹] ãƒœã‚¿ãƒ³                                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  S3: å£æ‰“ã¡ãƒãƒ£ãƒƒãƒˆ  /chat?subsidy_id=XXX&company_id=YYY          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 1. äº‹å‰åˆ¤å®š (precheck)                                        â”‚ â”‚
â”‚  â”‚    - NG: ç”³è«‹ä¸å¯ç†ç”±ã‚’è¡¨ç¤º â†’ çµ‚äº†                            â”‚ â”‚
â”‚  â”‚    - OK: ç”³è«‹å¯èƒ½ â†’ S4ã¸                                      â”‚ â”‚
â”‚  â”‚    - OK_WITH_MISSING: ä¸è¶³æƒ…å ±ã‚ã‚Š â†’ è³ªå•é–‹å§‹                 â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚ 2. ä¸è¶³æƒ…å ±åé›†ï¼ˆå£æ‰“ã¡ï¼‰                                     â”‚ â”‚
â”‚  â”‚    - ã‚·ã‚¹ãƒ†ãƒ ãŒè³ªå• â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå›ç­”                          â”‚ â”‚
â”‚  â”‚    - å›ç­”ã¯ chat_facts ã«ä¿å­˜ï¼ˆæ¬¡å›ä»¥é™èã‹ãªã„ï¼‰             â”‚ â”‚
â”‚  â”‚    - å…¨è³ªå•å®Œäº† â†’ S4ã¸                                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  S4: ç”³è«‹æ›¸ãƒ‰ãƒ©ãƒ•ãƒˆ  /draft?session_id=XXX                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 1. ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”Ÿæˆ                                           â”‚ â”‚
â”‚  â”‚    - 5ã‚»ã‚¯ã‚·ãƒ§ãƒ³: èƒŒæ™¯ãƒ»èª²é¡Œ / äº‹æ¥­ç›®çš„ / å®Ÿæ–½å†…å®¹ãƒ»æ–¹æ³•      â”‚ â”‚
â”‚  â”‚                   / å®Ÿæ–½ä½“åˆ¶ / è³‡é‡‘è¨ˆç”»ï¼ˆæ¦‚è¦ï¼‰                â”‚ â”‚
â”‚  â”‚    - æ ¹æ‹ : company_profile + chat_facts + subsidy_info        â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚ 2. NGãƒ•ã‚£ãƒ«ã‚¿ãƒã‚§ãƒƒã‚¯                                         â”‚ â”‚
â”‚  â”‚    - æ–­å®šè¡¨ç¾ãƒ»ä¸æ­£ç¤ºå”†ãƒ»ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹é•å ã‚’è­¦å‘Š          â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚ 3. ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç·¨é›† â†’ ä¿å­˜ â†’ ç¢ºå®š                               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
    [å®Œäº†]
```

---

## ãƒ‡ãƒ¼ã‚¿ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ãƒ‡ãƒ¼ã‚¿ã®å½¹å‰²åˆ†æ‹…

| å½¹å‰² | ãƒ†ãƒ¼ãƒ–ãƒ« | èª¬æ˜ |
|------|----------|------|
| åŸºæœ¬æƒ…å ± | companies + company_profile | æ¤œç´¢å‰ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆå½“ã¦ã¯ã¾ã‚‹ã‹å¦ã‹ï¼‰ |
| æ›¸é¡ | company_documents | è‡ªå‹•å…¥åŠ›ãƒ»è£å–ã‚Šç”¨ï¼ˆOCRæŠ½å‡ºäºˆå®šï¼‰ |
| å‰ææ¡ä»¶ | eligibility_rules | precheckåˆ¤å®šãƒ«ãƒ¼ãƒ« |
| å£æ‰“ã¡å›ç­” | chat_facts | ã€Œæ¬¡å›ä»¥é™èã‹ãªã„ã€è³‡ç”£ |
| ä¼šè©±ãƒ­ã‚° | chat_messages | UIè¡¨ç¤ºãƒ»ç›£æŸ»ç”¨ |
| ç”³è«‹æ›¸ | application_drafts | ãƒ‰ãƒ©ãƒ•ãƒˆãƒ»ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç† |

### ä¸»è¦ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§

| ãƒ†ãƒ¼ãƒ–ãƒ« | èª¬æ˜ |
|----------|------|
| `users` | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ |
| `companies` | ä¼šç¤¾åŸºæœ¬æƒ…å ± |
| `company_profile` | ä¼šç¤¾è©³ç´°ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« |
| `company_documents` | ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ›¸é¡ |
| `subsidy_cache` | è£œåŠ©é‡‘ã‚­ãƒ£ãƒƒã‚·ãƒ¥ |
| `eligibility_rules` | é©æ ¼æ€§åˆ¤å®šãƒ«ãƒ¼ãƒ« |
| `chat_sessions` | å£æ‰“ã¡ã‚»ãƒƒã‚·ãƒ§ãƒ³ |
| `chat_messages` | ãƒãƒ£ãƒƒãƒˆå±¥æ­´ |
| `chat_facts` | åé›†æ¸ˆã¿äº‹å®Ÿ |
| `application_drafts` | ç”³è«‹æ›¸ãƒ‰ãƒ©ãƒ•ãƒˆ |
| `source_registry` | 47éƒ½é“åºœçœŒã‚¯ãƒ­ãƒ¼ãƒ«å°å¸³ |
| `crawl_queue` | Cronã‚­ãƒ¥ãƒ¼ |
| `subsidy_lifecycle` | åˆ¶åº¦ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ« |

---

## API Endpoints

### èªè¨¼ API

| Endpoint | Method | èª¬æ˜ |
|----------|--------|------|
| `/api/auth/register` | POST | ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ² |
| `/api/auth/login` | POST | ãƒ­ã‚°ã‚¤ãƒ³ |
| `/api/auth/refresh` | POST | ãƒˆãƒ¼ã‚¯ãƒ³ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ |
| `/api/auth/forgot-password` | POST | ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆç”³è«‹ |
| `/api/auth/reset-password` | POST | ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œ |

### ä¼šç¤¾æƒ…å ± API

| Endpoint | Method | èª¬æ˜ |
|----------|--------|------|
| `/api/companies` | GET | ä¼šç¤¾ä¸€è¦§ |
| `/api/companies` | POST | ä¼šç¤¾ä½œæˆ |
| `/api/companies/:id` | GET | ä¼šç¤¾è©³ç´° |
| `/api/companies/:id` | PUT | ä¼šç¤¾æ›´æ–° |
| `/api/profile` | GET | ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«çµ±åˆå–å¾— |
| `/api/profile` | PUT | ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–° |
| `/api/profile/completeness` | GET | å®Œæˆåº¦å–å¾— |
| `/api/profile/documents` | POST | æ›¸é¡ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ |
| `/api/profile/documents` | GET | æ›¸é¡ä¸€è¦§ |
| `/api/profile/documents/:id` | DELETE | æ›¸é¡å‰Šé™¤ |

### è£œåŠ©é‡‘ API

| Endpoint | Method | èª¬æ˜ |
|----------|--------|------|
| `/api/subsidies` | GET | è£œåŠ©é‡‘æ¤œç´¢ |
| `/api/subsidies/:id` | GET | è£œåŠ©é‡‘è©³ç´° |

### S3: å£æ‰“ã¡ãƒãƒ£ãƒƒãƒˆ API

| Endpoint | Method | èª¬æ˜ |
|----------|--------|------|
| `/api/chat/precheck` | POST | äº‹å‰åˆ¤å®š |
| `/api/chat/sessions` | POST | ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ |
| `/api/chat/sessions` | GET | ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ |
| `/api/chat/sessions/:id` | GET | ã‚»ãƒƒã‚·ãƒ§ãƒ³è©³ç´° |
| `/api/chat/sessions/:id/message` | POST | ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ |

### S4: ç”³è«‹æ›¸ãƒ‰ãƒ©ãƒ•ãƒˆ API

| Endpoint | Method | èª¬æ˜ |
|----------|--------|------|
| `/api/draft/generate` | POST | ãƒ‰ãƒ©ãƒ•ãƒˆç”Ÿæˆ |
| `/api/draft/:id` | GET | ãƒ‰ãƒ©ãƒ•ãƒˆå–å¾— |
| `/api/draft/:id` | PUT | ãƒ‰ãƒ©ãƒ•ãƒˆæ›´æ–° |
| `/api/draft/:id/check-ng` | POST | NGãƒã‚§ãƒƒã‚¯å†å®Ÿè¡Œ |
| `/api/draft/:id/finalize` | POST | ãƒ‰ãƒ©ãƒ•ãƒˆç¢ºå®š |

### ãƒŠãƒ¬ãƒƒã‚¸ API (K1/K2)

| Endpoint | Method | èª¬æ˜ |
|----------|--------|------|
| `/api/knowledge/crawl/:urlId` | POST | URLå˜ä½“ã‚¯ãƒ­ãƒ¼ãƒ« |
| `/api/knowledge/extract/:urlId` | POST | ExtractæŠ½å‡º |
| `/api/knowledge/registry` | GET | source_registryä¸€è¦§ |
| `/api/knowledge/stats` | GET | ãƒŠãƒ¬ãƒƒã‚¸çµ±è¨ˆ |

### Consumer API

| Endpoint | Method | èª¬æ˜ |
|----------|--------|------|
| `/api/consumer/run` | POST | ã‚­ãƒ¥ãƒ¼ã‚¸ãƒ§ãƒ–å‡¦ç† |
| `/api/consumer/status` | GET | ã‚­ãƒ¥ãƒ¼çŠ¶æ…‹ |
| `/api/consumer/requeue/:id` | POST | å†ã‚­ãƒ¥ãƒ¼ |
| `/api/consumer/cleanup` | DELETE | å¤ã„ã‚¸ãƒ§ãƒ–å‰Šé™¤ |

---

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Cloudflare (Phase K2 + S3/S4)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Pages (hojyokin)                                          â”‚  â”‚
â”‚  â”‚ - èªè¨¼ (JWT + PBKDF2)                                     â”‚  â”‚
â”‚  â”‚ - ä¼æ¥­CRUD + Profile                                      â”‚  â”‚
â”‚  â”‚ - è£œåŠ©é‡‘æ¤œç´¢ (JGrants API)                                â”‚  â”‚
â”‚  â”‚ - S3: å£æ‰“ã¡ãƒãƒ£ãƒƒãƒˆ (precheck + factsåé›†)               â”‚  â”‚
â”‚  â”‚ - S4: ç”³è«‹æ›¸ãƒ‰ãƒ©ãƒ•ãƒˆ (ãƒ†ãƒ³ãƒ—ãƒ¬ç”Ÿæˆ + NGãƒ•ã‚£ãƒ«ã‚¿)          â”‚  â”‚
â”‚  â”‚ - ãƒŠãƒ¬ãƒƒã‚¸ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ (K1/K2)                            â”‚  â”‚
â”‚  â”‚ - Consumer (crawl_queueå‡¦ç†)                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Cron Worker (hojyokin-cron)                              â”‚  â”‚
â”‚  â”‚ - scheduled: æ¯æ—¥03:00 JST                                â”‚  â”‚
â”‚  â”‚ - dueæŠ½å‡º â†’ crawl_queueæŠ•å…¥                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚     D1      â”‚ â”‚     R2      â”‚ â”‚   Firecrawl â”‚              â”‚
â”‚  â”‚ (SQLite)    â”‚ â”‚ (knowledge) â”‚ â”‚   (Scrape)  â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å®Ÿè£…æ¸ˆã¿æ©Ÿèƒ½ âœ…

### Phase 1-A (CloudflareåŸºç›¤)
- [x] èªè¨¼ (JWT + PBKDF2)
- [x] ä¼æ¥­CRUD
- [x] JGrants Adapter (live/mock/cached-only)
- [x] ä¸€æ¬¡ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°
- [x] D1ã‚­ãƒ£ãƒƒã‚·ãƒ¥

### Phase K1 (ãƒŠãƒ¬ãƒƒã‚¸åé›†)
- [x] Firecrawl scrape â†’ R2 rawä¿å­˜
- [x] source_urlç®¡ç†
- [x] content_hashå·®åˆ†æ¤œçŸ¥

### Phase K2 (å·®åˆ†æ›´æ–°)
- [x] Extract Schema v1 (Firecrawl v2 API)
- [x] 47éƒ½é“åºœçœŒå°å¸³ (source_registry)
- [x] Cron Worker (dueæŠ½å‡º â†’ crawl_queueæŠ•å…¥)
- [x] Consumer (crawl_queueå‡¦ç†)
- [x] domain_policy (è‡ªå‹•ãƒ–ãƒ­ãƒƒã‚¯)

### S3: å£æ‰“ã¡ãƒãƒ£ãƒƒãƒˆ âœ…
- [x] POST /api/chat/precheckï¼ˆäº‹å‰åˆ¤å®š: NG/OK/OK_WITH_MISSINGï¼‰
- [x] POST /api/chat/sessionsï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆï¼‹åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰
- [x] GET /api/chat/sessionsï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ï¼‰
- [x] GET /api/chat/sessions/:idï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³è©³ç´°ï¼‰
- [x] POST /api/chat/sessions/:id/messageï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ï¼‹factsä¿å­˜ï¼‰
- [x] /chat UIï¼ˆãƒ—ãƒ¬ãƒã‚§ãƒƒã‚¯è¡¨ç¤ºã€è³ªå•å¿œç­”ã€ã‚¯ã‚¤ãƒƒã‚¯å›ç­”ï¼‰
- [x] chat_sessions / chat_messages / chat_facts ãƒ†ãƒ¼ãƒ–ãƒ«
- [x] /subsidies/:id â†’ /chat å°ç·šæ¥ç¶š

### S4: ç”³è«‹æ›¸ãƒ‰ãƒ©ãƒ•ãƒˆ âœ…
- [x] POST /api/draft/generateï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ï¼‹å¤‰æ•°åŸ‹ã‚è¾¼ã¿ç”Ÿæˆï¼‰
- [x] GET /api/draft/:idï¼ˆãƒ‰ãƒ©ãƒ•ãƒˆå–å¾—ï¼‰
- [x] PUT /api/draft/:idï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³æ›´æ–°ï¼‹NGå†è©•ä¾¡ï¼‰
- [x] POST /api/draft/:id/check-ngï¼ˆNGãƒã‚§ãƒƒã‚¯å†å®Ÿè¡Œï¼‰
- [x] POST /api/draft/:id/finalizeï¼ˆãƒ‰ãƒ©ãƒ•ãƒˆç¢ºå®šï¼‰
- [x] /draft UIï¼ˆ5ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç·¨é›†ã€NGãƒã‚§ãƒƒã‚¯ã€è‡ªå‹•ä¿å­˜ã€ç¢ºå®šï¼‰
- [x] application_drafts ãƒ†ãƒ¼ãƒ–ãƒ«
- [x] /chat å®Œäº† â†’ /draft å°ç·šæ¥ç¶š
- [x] NGãƒ•ã‚£ãƒ«ã‚¿ãƒ«ãƒ¼ãƒ«ï¼ˆæ–­å®šè¡¨ç¾ãƒ»ä¸æ­£ç¤ºå”†ãƒ»ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ï¼‰

---

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ— ğŸ“‹

### Phase 2 (å„ªå…ˆ)
1. **æ›¸é¡ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ â†’ è‡ªå‹•å…¥åŠ›**
   - OCR/LLMæŠ½å‡º â†’ extracted_json
   - company_profile ã¸ã®è‡ªå‹•åæ˜ 
   
2. **LLMãƒ–ãƒ©ãƒƒã‚·ãƒ¥ã‚¢ãƒƒãƒ—**
   - mode=llm ã§ãƒ‰ãƒ©ãƒ•ãƒˆæ–‡ç« ã‚’è‡ªç„¶åŒ–
   
3. **PDFå‡ºåŠ›**
   - ç¢ºå®šãƒ‰ãƒ©ãƒ•ãƒˆã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

### æ©Ÿèƒ½æ‹¡å¼µ
- [ ] æ¤œç´¢ã®ã€Œå½“ã¦ã¯ã¾ã‚‹ã‚‚ã®å„ªå…ˆã€ãƒˆã‚°ãƒ«
- [ ] NGè‡ªå‹•å·®ã—æ›¿ãˆææ¡ˆ
- [ ] åŠ ç‚¹è¦ç´ ã®è¡¨ç¤ºï¼ˆbonus_*ï¼‰
- [ ] ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®š

---

## é–‹ç™ºç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

```bash
# ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
cd /home/user/webapp
npm install

# D1ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ (ãƒ­ãƒ¼ã‚«ãƒ«)
npx wrangler d1 migrations apply subsidy-matching-production --local

# ãƒ“ãƒ«ãƒ‰
npm run build

# é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•
pm2 start ecosystem.config.cjs

# API ãƒ†ã‚¹ãƒˆ
curl http://localhost:3000/api/health
```

### E2Eãƒ†ã‚¹ãƒˆ

```bash
# ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ² â†’ ä¼šç¤¾ä½œæˆ â†’ ãƒãƒ£ãƒƒãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ â†’ ãƒ‰ãƒ©ãƒ•ãƒˆç”Ÿæˆ
TOKEN=$(curl -s http://localhost:3000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"Test1234!","name":"ãƒ†ã‚¹ãƒˆ"}' \
  | jq -r '.data.token')

# ä¼šç¤¾ä½œæˆ
COMPANY_ID=$(curl -s http://localhost:3000/api/companies \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"name":"ãƒ†ã‚¹ãƒˆæ ªå¼ä¼šç¤¾","prefecture":"æ±äº¬éƒ½","industry_major":"G","employee_count":10}' \
  | jq -r '.data.id')

# ãƒãƒ£ãƒƒãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
SESSION_ID=$(curl -s http://localhost:3000/api/chat/sessions \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"subsidy_id":"test-subsidy-001","company_id":"'$COMPANY_ID'"}' \
  | jq -r '.data.session.id')

# ãƒ‰ãƒ©ãƒ•ãƒˆç”Ÿæˆ
curl -s http://localhost:3000/api/draft/generate \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"session_id":"'$SESSION_ID'","mode":"template"}'
```

---

## ç’°å¢ƒå¤‰æ•°

### Cloudflare (.dev.vars)
```
JWT_SECRET=your-secret-key-32-chars-minimum
JWT_ISSUER=subsidy-app
JWT_AUDIENCE=subsidy-app-users
JGRANTS_MODE=mock
FIRECRAWL_API_KEY=fc-xxx
```

---

## ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«

| ãƒ•ã‚¡ã‚¤ãƒ« | èª¬æ˜ |
|----------|------|
| 0001_initial_schema.sql | åŸºæœ¬ã‚¹ã‚­ãƒ¼ãƒ |
| 0002_eligibility_rules.sql | é©æ ¼æ€§ãƒ«ãƒ¼ãƒ« |
| 0003_knowledge_pipeline.sql | ãƒŠãƒ¬ãƒƒã‚¸ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ |
| ... | ... |
| 0015_company_profile.sql | ä¼šç¤¾ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ‹¡å¼µ |
| 0016_s3_s4_chat_draft.sql | S3/S4: ãƒãƒ£ãƒƒãƒˆï¼‹ãƒ‰ãƒ©ãƒ•ãƒˆ |
| 0017_company_documents_raw_text.sql | æ›¸é¡ãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡º |
| 0017_security_tables.sql | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ãƒ¼ãƒ–ãƒ« |
| 0018_usage_events.sql | åˆ©ç”¨ã‚¤ãƒ™ãƒ³ãƒˆ |
| 0019_agency_tables.sql | Agencyï¼ˆå£«æ¥­ï¼‰æ©Ÿèƒ½: agencies, agency_members, agency_clients, access_links, intake_submissions, chat_answers, notifications |
| 0020_agency_intake_extension.sql | Intakeå¼·åŒ–: intake_link_templates, intake_field_mappings, agency_client_history |
| 0021_superadmin_kpi_cost.sql | Superadmin KPI: event_log, cost_usage_log, data_freshness_log, kpi_daily_snapshots, alert_rules, alert_history |
| 0022_program_items.sql | L3ç¶²ç¾…æ€§: program_itemsï¼ˆå‹Ÿé›†æ¡ˆä»¶å°å¸³ï¼‰, program_item_history, coverage_snapshots |
| 0099_reconcile_schema.sql | å†ªç­‰ãªçµ±åˆãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆæœ¬ç•ªã‚¹ã‚­ãƒ¼ãƒã¨ã®æ•´åˆæ€§ç¢ºä¿ï¼‰|

---

## Agencyï¼ˆå£«æ¥­ï¼‰æ©Ÿèƒ½

### ãƒ­ãƒ¼ãƒ«å®šç¾©
- **user**: è‡ªç¤¾ã®åˆ©ç”¨ï¼ˆç¾çŠ¶ã®ç”³è«‹å°ç·šï¼‰
- **agency**: é¡§å®¢ä¼æ¥­ã‚’è¤‡æ•°ç®¡ç†ã—ã€é¡§å®¢ã®ä»£ç†ã§æ¤œç´¢ãƒ»å£æ‰“ã¡ãƒ»ãƒ‰ãƒ©ãƒ•ãƒˆä½œæˆã¾ã§å¯èƒ½
- **superadmin**: å…¨ä½“ç®¡ç†ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°/KPI/ã‚³ã‚¹ãƒˆ/ã‚¯ãƒ­ãƒ¼ãƒ«çŠ¶æ³/ç›£æŸ»ï¼‰

### Agency æ©Ÿèƒ½ã®2ç¨®é¡ã®ãƒªãƒ³ã‚¯

#### Link-1: ä¼æ¥­æƒ…å ±å…¥åŠ›ãƒªãƒ³ã‚¯ï¼ˆCompany Intake Linkï¼‰
- **ç›®çš„**: é¡§å®¢ã«æ¸¡ã—ã¦ä¼æ¥­æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ã‚‚ã‚‰ã†
- **URL**: `/intake?code=XXXXXXXX`
- **èªè¨¼**: ãƒ­ã‚°ã‚¤ãƒ³ä¸è¦ï¼ˆçŸ­ç¸®ã‚³ãƒ¼ãƒ‰ã§èªè¨¼ï¼‰
- **æ©Ÿèƒ½**: ä¼šç¤¾åãƒ»æ‰€åœ¨åœ°ãƒ»æ¥­ç¨®ãƒ»å¾“æ¥­å“¡æ•°ãƒ»è³‡æœ¬é‡‘ç­‰ã®å…¥åŠ›

#### Link-2: å£æ‰“ã¡å›ç­”ãƒªãƒ³ã‚¯ï¼ˆChat Answer Linkï¼‰
- **ç›®çš„**: å£æ‰“ã¡ã§ç™ºç”Ÿã—ãŸè¿½åŠ è³ªå•ã«é¡§å®¢ãŒå›ç­”
- **URL**: `/answer?code=XXXXXXXX`
- **èªè¨¼**: ãƒ­ã‚°ã‚¤ãƒ³ä¸è¦
- **æ©Ÿèƒ½**: è£œåŠ©é‡‘ç”³è«‹ã«å¿…è¦ãªè¿½åŠ æƒ…å ±ã®å›ç­”

### Agency API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | ãƒ¡ã‚½ãƒƒãƒ‰ | èª¬æ˜ |
|---------------|---------|------|
| `/api/agency/me` | GET | è‡ªåˆ†ã®agencyæƒ…å ±å–å¾— |
| `/api/agency/me` | PUT | agencyæƒ…å ±æ›´æ–° |
| `/api/agency/dashboard` | GET | ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰çµ±è¨ˆ |
| `/api/agency/clients` | GET | é¡§å®¢ä¸€è¦§ |
| `/api/agency/clients` | POST | é¡§å®¢è¿½åŠ  |
| `/api/agency/clients/:id` | GET | é¡§å®¢è©³ç´° |
| `/api/agency/clients/:id` | PUT | é¡§å®¢æ›´æ–° |
| `/api/agency/links` | POST | ãƒªãƒ³ã‚¯ç™ºè¡Œ |
| `/api/agency/links` | GET | ãƒªãƒ³ã‚¯ä¸€è¦§ |
| `/api/agency/links/:id` | DELETE | ãƒªãƒ³ã‚¯ç„¡åŠ¹åŒ– |
| `/api/agency/submissions` | GET | å…¥åŠ›å—ä»˜ä¸€è¦§ |
| `/api/agency/submissions/:id/approve` | POST | å…¥åŠ›æ‰¿èªï¼ˆä¼šç¤¾æƒ…å ±ã«åæ˜ ï¼‰ |
| `/api/agency/submissions/:id/reject` | POST | å…¥åŠ›å´ä¸‹ |

### é¡§å®¢ãƒãƒ¼ã‚¿ãƒ« API

| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | ãƒ¡ã‚½ãƒƒãƒ‰ | èª¬æ˜ |
|---------------|---------|------|
| `/api/portal/verify` | GET | ãƒªãƒ³ã‚¯æ¤œè¨¼ |
| `/api/portal/company` | GET | ä¼šç¤¾æƒ…å ±å–å¾— |
| `/api/portal/intake` | POST | ä¼æ¥­æƒ…å ±å…¥åŠ› |
| `/api/portal/questions` | GET | å£æ‰“ã¡è³ªå•å–å¾— |
| `/api/portal/answer` | POST | å£æ‰“ã¡è³ªå•å›ç­” |

---

## é‹ç”¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

ã‚¯ãƒ­ãƒ¼ãƒ«é‹ç”¨ãƒ»ç¶²ç¾…æ€§æ¤œè¨¼ãƒ»ã‚³ã‚¹ãƒˆç®¡ç†ã«é–¢ã™ã‚‹è©³ç´°ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ä»¥ä¸‹ã‚’å‚ç…§:

| ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ | èª¬æ˜ |
|-------------|------|
| [docs/operations/target_registry_master.csv](docs/operations/target_registry_master.csv) | 47éƒ½é“åºœçœŒ+å›½ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå°å¸³ï¼ˆsource_registryæŠ•å…¥ç”¨ï¼‰ |
| [docs/operations/weekly_crawl_plan.md](docs/operations/weekly_crawl_plan.md) | é€±1å…¨é‡ã‚¯ãƒ­ãƒ¼ãƒ«è¨ˆç”»ã€Phase 0/1 ã®å®Ÿè¡Œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« |
| [docs/operations/verification_checklist.md](docs/operations/verification_checklist.md) | å–å¾—å“è³ªãƒã‚§ãƒƒã‚¯è¡¨ã€L1/L2/L3ç¶²ç¾…æ€§æ¤œè¨¼SQL |
| [docs/operations/cost_estimation_template.md](docs/operations/cost_estimation_template.md) | ã‚³ã‚¹ãƒˆæ¦‚ç®—ãƒ†ãƒ³ãƒ—ãƒ¬ã€ç„¡é§„ã‚³ã‚¹ãƒˆæ¤œçŸ¥ã‚¯ã‚¨ãƒª |

---

## Superadmin KPIãƒ»ç›£è¦–æ©Ÿèƒ½

### KPI ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ API

| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | ãƒ¡ã‚½ãƒƒãƒ‰ | èª¬æ˜ | ã‚¢ã‚¯ã‚»ã‚¹ |
|---------------|---------|------|---------|
| `/api/admin/dashboard` | GET | KPI + ã‚­ãƒ¥ãƒ¼çŠ¶æ³ | admin, super_admin |
| `/api/admin/costs` | GET | ã‚³ã‚¹ãƒˆé›†è¨ˆ | super_admin ã®ã¿ |
| `/api/admin/updates` | GET | æ›´æ–°çŠ¶æ³ä¸€è¦§ | admin, super_admin |
| `/api/admin/agency-kpi` | GET | Agencyçµ±è¨ˆ | super_admin ã®ã¿ |
| `/api/admin/data-freshness` | GET | ãƒ‡ãƒ¼ã‚¿é®®åº¦ç›£è¦– | super_admin ã®ã¿ |
| `/api/admin/alerts` | GET | ã‚¢ãƒ©ãƒ¼ãƒˆä¸€è¦§ | super_admin ã®ã¿ |
| `/api/admin/kpi-history` | GET | KPIå±¥æ­´å–å¾— | super_admin ã®ã¿ |
| `/api/admin/generate-daily-snapshot` | POST | æ—¥æ¬¡KPIã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆç”Ÿæˆ | super_admin ã®ã¿ |
| `/api/admin/coverage` | GET | L1/L2/L3ç¶²ç¾…æ€§ãƒã‚§ãƒƒã‚¯ + é‹ç”¨ç›£è¦–KPI | super_admin ã®ã¿ |
| `/api/admin/debug/company-check` | GET | ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¼šç¤¾ç´ã¥ã‘è¨ºæ–­ï¼ˆ?email=xxxï¼‰ | super_admin ã®ã¿ |

### ç›£è¦–ãƒ†ãƒ¼ãƒ–ãƒ«

| ãƒ†ãƒ¼ãƒ–ãƒ« | ç”¨é€” |
|----------|------|
| event_log | æ±ç”¨ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°ï¼ˆç›£æŸ»ãƒ»åˆ†æï¼‰ |
| cost_usage_log | ã‚³ã‚¹ãƒˆè©³ç´°ãƒ­ã‚°ï¼ˆè«‹æ±‚ãƒ»äºˆç®—ç®¡ç†ï¼‰ |
| data_freshness_log | ãƒ‡ãƒ¼ã‚¿é®®åº¦ç›£è¦– |
| kpi_daily_snapshots | æ—¥æ¬¡KPIã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ |
| alert_rules | ã‚¢ãƒ©ãƒ¼ãƒˆãƒ«ãƒ¼ãƒ«è¨­å®š |
| alert_history | ã‚¢ãƒ©ãƒ¼ãƒˆç™ºå ±å±¥æ­´ |
| program_items | å‹Ÿé›†æ¡ˆä»¶å°å¸³ï¼ˆL3ç¶²ç¾…æ€§æ¸¬å®šï¼‰ |
| coverage_snapshots | ç¶²ç¾…æ€§æ—¥æ¬¡ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ |

---

## ã‚³ãƒ¼ãƒ‰å“è³ªã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

### ç›®æ¨™
- æŠ€è¡“è² å‚µã‚’é˜²ãã€é‹ç”¨ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆã‚’èµ·ã“ã•ãªã„ã€ä¿¡é ¼ã§ãã‚‹ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã
- ã€Œé€Ÿãå‹•ãã€ã‚ˆã‚Šã€Œæ­£ã—ãå‹•ãã€ã‚’å„ªå…ˆ

### å¿…é ˆãƒã‚§ãƒƒã‚¯é …ç›®

#### 1. å…¥åŠ›ã®å®‰å…¨æ€§
- null/undefined/ç©ºå€¤ã®å‡¦ç†
- å‹æ¤œè¨¼ï¼ˆJSON.parseæ™‚ã®try-catchå¿…é ˆï¼‰
- å¢ƒç•Œå€¤ï¼ˆ0ã€è² æ•°ã€æœ€å¤§å€¤ã€ç©ºé…åˆ—ï¼‰

```javascript
// âœ… Good
var userStr = localStorage.getItem('user');
var user = null;
try {
  user = userStr ? JSON.parse(userStr) : null;
} catch (e) {
  console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', e);
  user = null;
}

// âŒ Bad
var user = JSON.parse(localStorage.getItem('user'));
```

#### 2. ãƒ­ã‚¸ãƒƒã‚¯ã®æ­£ç¢ºæ€§
- æ¡ä»¶åˆ†å²æ¼ã‚Œ
- ãƒ«ãƒ¼ãƒ—çµ‚äº†æ¡ä»¶
- è¨ˆç®—å¼ãƒ»æ¯”è¼ƒæ¼”ç®—å­ã®èª¤ã‚Š

#### 3. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- ä¾‹å¤–æ™‚ã®æŒ™å‹•
- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®åŸå› ç‰¹å®šæ€§
- ãƒªã‚½ãƒ¼ã‚¹è§£æ”¾

```javascript
// âœ… Good
try {
  var res = await fetch(path, fetchOptions);
  var data = await res.json();
  return data;
} catch (err) {
  console.error('APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼:', err);
  return { success: false, error: { code: 'NETWORK_ERROR', message: 'é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' } };
}
```

#### 4. æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã¨ã®æ•´åˆæ€§
- å‘½åè¦å‰‡ãƒ»è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³ã®çµ±ä¸€
- å‰æãƒ»åˆ¶ç´„ã¨ã®çŸ›ç›¾å›é¿
- ä¾å­˜é–¢ä¿‚ã®ç¢ºèª

#### 5. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
- å…¥åŠ›ã‚µãƒ‹ã‚¿ã‚¤ã‚º
- èªè¨¼/èªå¯ãƒã‚§ãƒƒã‚¯
- æ©Ÿå¯†æƒ…å ±ã®ãƒ­ã‚°å‡ºåŠ›ãƒ»ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç¦æ­¢

#### 6. è¨­å®šãƒ»ã‚¤ãƒ³ãƒ•ãƒ©
- ç’°å¢ƒå¤‰æ•°ãƒ»ãƒ‘ã‚¹ãƒ»æ¨©é™è¨­å®š
- ç’°å¢ƒä¾å­˜å€¤ã®ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å›é¿

### JavaScript ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦å‰‡

#### APIå‘¼ã³å‡ºã—
- å…¨ãƒšãƒ¼ã‚¸ã§çµ±ä¸€ã•ã‚ŒãŸ `window.api()` ã¾ãŸã¯ `window.apiCall()` ã‚’ä½¿ç”¨
- èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã¯è‡ªå‹•ä»˜ä¸
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¯å…±é€šé–¢æ•°å†…ã§å®Ÿæ–½

```javascript
// âœ… æ¨å¥¨ãƒ‘ã‚¿ãƒ¼ãƒ³
window.api = async function(path, options) {
  options = options || {};
  
  var headers = {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer ' + token
  };
  
  // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ãƒãƒ¼ã‚¸
  if (options.headers) {
    for (var key in options.headers) {
      headers[key] = options.headers[key];
    }
  }
  
  var fetchOptions = {
    method: options.method || 'GET',
    headers: headers
  };
  
  if (options.body) {
    fetchOptions.body = options.body;
  }
  
  try {
    var res = await fetch(path, fetchOptions);
    var data = await res.json();
    return data;
  } catch (err) {
    console.error('APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼:', err);
    return { success: false, error: { code: 'NETWORK_ERROR', message: 'é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' } };
  }
};
```

#### DOMæ“ä½œ
- è¦ç´ å–å¾—å¾Œã¯å¿…ãšnullãƒã‚§ãƒƒã‚¯

```javascript
// âœ… Good
var el = document.getElementById('user-name');
if (el) {
  el.textContent = user.name || '';
}

// âŒ Bad
document.getElementById('user-name').textContent = user.name;
```

#### ES5äº’æ›æ€§
- `var` ã‚’ä½¿ç”¨ï¼ˆ`let`/`const` ã¯ä¸€éƒ¨å¤ã„ãƒ–ãƒ©ã‚¦ã‚¶ã§å•é¡Œï¼‰
- ã‚¢ãƒ­ãƒ¼é–¢æ•°ã¯ä½¿ã‚ãš `function` ã‚’ä½¿ç”¨ï¼ˆãŸã ã—ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒªãƒ†ãƒ©ãƒ«å†…ã®JSã§ã¯å¯ï¼‰

### å‡ºåŠ›ãƒ«ãƒ¼ãƒ«
- âš ï¸ æ‡¸å¿µç‚¹ã‚’æ˜è¨˜
- ç¢ºä¿¡ãŒæŒã¦ãªã„å®Ÿè£…ã«ã¯ `// TODO: è¦ç¢ºèª` ã‚’ä»˜ã‘ã‚‹
- è¤‡æ•°å®Ÿè£…æ™‚ã¯ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ã‚’èª¬æ˜
- ã€ŒãŸã¶ã‚“å‹•ãã€ã‚³ãƒ¼ãƒ‰ã¯å‡ºã•ãªã„

### ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ (2026-01-22 æ›´æ–°)

#### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ (pages/*.tsx)
| ãƒ•ã‚¡ã‚¤ãƒ« | çŠ¶æ…‹ | ç¢ºèªé …ç›® |
|----------|------|----------|
| dashboard.tsx | âœ… | apiCallçµ±ä¸€ã€JSON.parse try-catchã€DOM null ãƒã‚§ãƒƒã‚¯ |
| subsidies.tsx | âœ… | api()çµ±ä¸€ã€å¢ƒç•Œå€¤å‡¦ç†ã€Dateç„¡åŠ¹å€¤ãƒã‚§ãƒƒã‚¯è¿½åŠ  |
| chat.tsx | âœ… | api()çµ±ä¸€ã€escapeHtmlå®Ÿè£…ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° |
| draft.tsx | âœ… | window.api()ä½¿ç”¨ã€è‡ªå‹•ä¿å­˜ã€NGãƒã‚§ãƒƒã‚¯ |
| agency.tsx | âœ… | apiCallçµ±ä¸€ã€RBAC (role === 'agency')ã€JSON.parse try-catch |
| admin.tsx | âœ… | api()çµ±ä¸€ã€RBAC (admin/super_admin)ã€JSON.parse try-catch |
| portal.tsx | âœ… | èªè¨¼ä¸è¦ã€ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹æ¤œè¨¼ã§ä¿è­· |
| auth.tsx | âœ… | èªè¨¼ä¸è¦ã€ç›´æ¥fetchä½¿ç”¨ |

#### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ (routes/*.ts)
| ãƒ•ã‚¡ã‚¤ãƒ« | çŠ¶æ…‹ | ç¢ºèªé …ç›® |
|----------|------|----------|
| chat.ts | âœ… | requireAuthã€å…¥åŠ›æ¤œè¨¼ã€factsMapå®‰å…¨å‡¦ç† |
| draft.ts | âœ… | requireAuthã€NG_RULESã€RegExp lastIndexãƒªã‚»ãƒƒãƒˆ |
| agency.ts | âœ… | requireAuthã€getUserAgencyæ¨©é™ãƒã‚§ãƒƒã‚¯ã€allowedFields ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆã€JSON.parse try-catchè¿½åŠ  |
| subsidies.ts | âœ… | requireAuthã€requireCompanyAccessã€JGrantsErrorãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° |

---

## ãƒ©ã‚¤ã‚»ãƒ³ã‚¹

Private

## æ›´æ–°å±¥æ­´

- **2026-01-22**: é‹ç”¨ç›£è¦–å¼·åŒ–: /api/admin/coverage ã®æœ¬ç•ªã‚¹ã‚­ãƒ¼ãƒå¯¾å¿œï¼ˆgeo_id, queue_id, source_registry_idç­‰ï¼‰ã€ãƒ‰ãƒ¡ã‚¤ãƒ³åˆ¥ã‚¨ãƒ©ãƒ¼ç‡Top20ã€é‡è¤‡ã‚¯ãƒ­ãƒ¼ãƒ«æ¤œçŸ¥ã€ã‚­ãƒ¥ãƒ¼æ»ç•™è­¦å‘Š
- **2026-01-22**: usage_eventsè¨˜éŒ²å¼·åŒ–: SUBSIDY_SEARCH, CHAT_SESSION_STARTED, DRAFT_GENERATED ã‚’å„APIã§è‡ªå‹•è¨˜éŒ²
- **2026-01-22**: ç®¡ç†ç”»é¢æ”¹å–„: ã€Œä»Šæ—¥ã®ç›´è¿‘ã‚¤ãƒ™ãƒ³ãƒˆã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ ã€/api/admin/debug/company-checkï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ä¼šç¤¾ç´ã¥ã‘1ç™ºè¨ºæ–­ï¼‰
- **2026-01-22**: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´å‚™: docs/weekly_crawl_plan.mdï¼ˆé€±1å…¨é‡ã‚¯ãƒ­ãƒ¼ãƒ«è¨ˆç”»ï¼‰ã€docs/cost_estimation_template.mdï¼ˆã‚³ã‚¹ãƒˆæ¦‚ç®—ãƒ†ãƒ³ãƒ—ãƒ¬ï¼‰
- **2026-01-22**: Migrationæ•´åˆå¼·åŒ–: 0099_reconcile_schema.sqlï¼ˆå†ªç­‰çµ±åˆãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰ä½œæˆã€tools/snapshot_production_schema.mjsï¼ˆæœ¬ç•ªã‚¹ã‚­ãƒ¼ãƒã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãƒ„ãƒ¼ãƒ«ï¼‰è¿½åŠ 
- **2026-01-22**: ç¶²ç¾…æ€§ç›£è¦–æ©Ÿèƒ½: 0022_program_items.sqlï¼ˆå‹Ÿé›†æ¡ˆä»¶å°å¸³ï¼‰è¿½åŠ ã€/api/admin/coverage ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆè¿½åŠ ï¼ˆL1/L2/L3ç¶²ç¾…æ€§ãƒã‚§ãƒƒã‚¯ï¼‰
- **2026-01-22**: UIå…±é€šåŒ–: public/static/common.js ã«apiCallé›†ç´„ã€èªè¨¼ã‚¨ãƒ©ãƒ¼æ™‚ã®è‡ªå‹•ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½
- **2026-01-22**: Agency Intakeå¼·åŒ– (0020), Superadmin KPIãƒ»ç›£è¦–æ©Ÿèƒ½ (0021) ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¿½åŠ 
- **2026-01-22**: admin-dashboard.ts ã« agency-kpi, data-freshness, alerts, kpi-history APIè¿½åŠ 
- **2026-01-22**: å…¨ãƒšãƒ¼ã‚¸ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†ã€subsidies.tsxå¢ƒç•Œå€¤å‡¦ç†è¿½åŠ ã€agency.ts JSON.parse try-catchè¿½åŠ 
- **2026-01-22**: ã‚³ãƒ¼ãƒ‰å“è³ªã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³æ•´å‚™ã€å…¨ãƒšãƒ¼ã‚¸ã®æŠ€è¡“è² å‚µè§£æ¶ˆ
- **2026-01-22**: S4 ç”³è«‹æ›¸ãƒ‰ãƒ©ãƒ•ãƒˆç”Ÿæˆ å®Œäº†
- **2026-01-22**: S3 å£æ‰“ã¡ãƒãƒ£ãƒƒãƒˆ å®Œäº†
- **2026-01-21**: Phase K2 Cron + Consumerå®Ÿè£…å®Œäº†
- **2026-01-21**: 47éƒ½é“åºœçœŒå°å¸³æŠ•å…¥
- **2026-01-21**: Extract Schema v1å®Ÿè£…
- **2026-01-21**: Phase 1-Aå®Œäº†ã€Phase 2 AWSè¨­è¨ˆå®Œäº†
