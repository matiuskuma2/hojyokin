# システム概要

## プロジェクト情報

| 項目 | 値 |
|------|-----|
| プロジェクト名 | subsidy-matching (hojyokin) |
| バージョン | 1.3.0 |
| 目的 | 補助金・助成金の自動マッチング＆申請書作成支援 |

## 設計思想

> **「補助金を"通す"ツール」ではなく「補助金で人生を壊させないツール」**

- 採択より完走
- 金額より安全
- 自動化より判断補助

---

## システムフロー（S1〜S4）

```
[ユーザー登録] → [会社情報登録]
                       │
                       ▼
┌──────────────────────────────────────────────────────────────────┐
│  S1: 補助金検索  /subsidies                                       │
│  - 企業情報（業種・規模・地域）でフィルタリング                    │
│  - 当てはまるもの優先表示 / 全件表示 切替                          │
└──────────────────────────────────────────────────────────────────┘
                       │
                       ▼
┌──────────────────────────────────────────────────────────────────┐
│  S2: 補助金詳細  /subsidies/:id                                   │
│  - 制度概要・申請要件・締切・補助率 等                             │
│  - [壁打ちを開始] ボタン → S3へ                                   │
└──────────────────────────────────────────────────────────────────┘
                       │
                       ▼
┌──────────────────────────────────────────────────────────────────┐
│  S3: 壁打ちチャット  /chat?subsidy_id=XXX&company_id=YYY          │
│  1. 事前判定 (precheck)                                          │
│     - NG → 申請不可理由を表示 → 終了                              │
│     - OK → S4へ直行                                              │
│     - OK_WITH_MISSING → 質問開始                                  │
│  2. 不足情報収集（壁打ち）                                        │
│     - 回答は chat_facts に保存（次回以降聞かない）                │
└──────────────────────────────────────────────────────────────────┘
                       │
                       ▼
┌──────────────────────────────────────────────────────────────────┐
│  S4: 申請書ドラフト  /draft?session_id=XXX                        │
│  1. テンプレート生成（5セクション）                               │
│  2. NGフィルタチェック                                           │
│  3. セクション編集 → 保存 → 確定                                  │
└──────────────────────────────────────────────────────────────────┘
                       │
                       ▼
                    [完了]
```

---

## アーキテクチャ（役割分担）

```
┌─────────────────────────────────────────────────────────────────┐
│                    Cloudflare (メイン基盤)                       │
│                                                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ Pages (hojyokin) - UI/API                                 │  │
│  │ ├─ 認証 (JWT + PBKDF2)                                    │  │
│  │ ├─ 企業CRUD + Profile                                     │  │
│  │ ├─ 補助金検索 (JGrants API)                               │  │
│  │ ├─ S3: 壁打ちチャット                                     │  │
│  │ ├─ S4: 申請書ドラフト                                     │  │
│  │ ├─ ナレッジパイプライン (K1/K2)                           │  │
│  │ └─ Consumer (crawl_queue処理)                             │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              │                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ Cron Worker (hojyokin-cron) - 定期実行                    │  │
│  │ └─ 毎日03:00 JST: due抽出 → crawl_queue投入               │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              │                                  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │     D1      │  │     R2      │  │  Firecrawl  │             │
│  │  (SQLite)   │  │ (knowledge) │  │  (Scrape)   │             │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
└─────────────────────────────────────────────────────────────────┘
                               │
                               ▼ (重処理のみ・将来)
┌─────────────────────────────────────────────────────────────────┐
│                      AWS (Phase 2予定)                          │
│  API Gateway → Lambda → SQS → Lambda(worker) → LLM             │
└─────────────────────────────────────────────────────────────────┘
```

---

## データの役割分担

| 役割 | テーブル | 説明 |
|------|----------|------|
| 基本情報 | `companies` + `company_profile` | 検索前フィルタ（当てはまるか否か） |
| 書類 | `company_documents` | 自動入力・裏取り用（OCR抽出予定） |
| 前提条件 | `eligibility_rules` | precheck判定ルール |
| 壁打ち回答 | `chat_facts` | 「次回以降聞かない」資産 |
| 会話ログ | `chat_messages` | UI表示・監査用 |
| 申請書 | `application_drafts` | ドラフト・バージョン管理 |
| 補助金 | `subsidy_cache` + `subsidy_metadata` | JGrants APIキャッシュ |
| ナレッジ | `doc_object` + `source_url` | クロール結果 |

---

## URL一覧

### 本番環境

| ページ | URL |
|--------|-----|
| トップ | https://hojyokin.pages.dev |
| ログイン | https://hojyokin.pages.dev/login |
| 新規登録 | https://hojyokin.pages.dev/register |
| パスワード再発行 | https://hojyokin.pages.dev/forgot |
| ダッシュボード | https://hojyokin.pages.dev/dashboard |
| 会社情報 | https://hojyokin.pages.dev/company |
| 補助金一覧 | https://hojyokin.pages.dev/subsidies |
| 補助金詳細 | https://hojyokin.pages.dev/subsidies/:id |
| 壁打ちチャット | https://hojyokin.pages.dev/chat?session_id=XXX |
| 申請書ドラフト | https://hojyokin.pages.dev/draft?session_id=XXX |
| 管理画面 | https://hojyokin.pages.dev/admin |

### カスタムドメイン（検証中）

| ドメイン | 状態 |
|----------|------|
| hojyokintekiyou.com | 検証中 |
| www.hojyokintekiyou.com | 検証中 |

### 開発リソース

| リソース | URL |
|----------|-----|
| GitHub | https://github.com/matiuskuma2/hojyokin |
| Cloudflare Dashboard | https://dash.cloudflare.com/dd957a4b35780cdb5d2c8d0b021684c2/pages/view/hojyokin |
