# データ基盤構築 全体計画書

## 目次
1. [プロジェクト概要](#1-プロジェクト概要)
2. [現状分析](#2-現状分析)
3. [目標設定](#3-目標設定)
4. [コスト試算](#4-コスト試算)
5. [技術設計](#5-技術設計)
6. [実装フェーズ](#6-実装フェーズ)
7. [運用計画](#7-運用計画)

---

## 1. プロジェクト概要

### 1.1 目的
- 全国の補助金・助成金情報を網羅的に収集・管理するデータ基盤を構築
- 情報の泉レベル（約17,000件）の網羅性を目指す
- PDFから申請書類テンプレートを抽出し、制度ごとの申請支援を実現

### 1.2 現在の課題
- JグランツAPIのみで約500件（全体の約3%）
- 都道府県・市区町村の独自補助金が取得できていない
- PDF/申請様式の体系的な収集・管理ができていない

### 1.3 成功指標
| 指標 | 現状 | Phase1目標 | 最終目標 |
|------|------|-----------|---------|
| 収集件数 | 500件 | 5,000件 | 17,000件 |
| 都道府県カバー率 | 0% | 主要5都府県 | 47都道府県 |
| PDF取得率 | 0% | 30% | 80% |
| 申請書類テンプレート | 0件 | 500件 | 10,000件 |

---

## 2. 現状分析

### 2.1 既存DB設計（活用可能なテーブル）

```
■ データ収集基盤
├── source_registry          # クロール対象台帳（47都道府県+主要事務局）
├── crawl_queue              # クロールジョブキュー
├── domain_policy            # ドメイン別ポリシー
└── crawl_stats              # クロール統計

■ 補助金データ
├── subsidy_cache            # 補助金基本情報（JGrants等）
├── subsidy_lifecycle        # ライフサイクル管理
├── subsidy_rounds           # 募集回（第○回）
├── subsidy_documents        # PDF/様式管理
└── program_items            # 募集案件台帳（網羅性測定用）

■ 処理パイプライン
├── ocr_queue                # OCR処理キュー
├── extraction_results       # 抽出結果
└── subsidy_requirements     # 要件・対象経費・必要書類

■ 参照マスタ
├── feed_sources             # NEWSソースマスター（0027）
├── required_documents_master # 必要書類マスター
└── budget_close_patterns    # 予算枯渇検知パターン
```

### 2.2 既存Cronシステム（hojyokin-cron）
- 毎日03:00 JST実行
- source_registry / subsidy_lifecycle のdue抽出
- crawl_queueへのジョブ投入
- domain_policyによるブロック制御

### 2.3 データソース分析

#### 情報の泉の参考データ（目標母数）
| 地域区分 | 件数 | 主要地域 |
|----------|------|----------|
| 北海道・東北 | 3,202件 | 北海道1,052件 |
| 関東 | 4,598件 | 東京都1,549件 |
| 中部 | 4,148件 | 愛知県978件 |
| 関西 | 2,137件 | 大阪府546件 |
| 中国・四国 | 1,894件 | 広島県244件 |
| 九州・沖縄 | 2,506件 | 福岡県539件 |
| **合計** | **約17,000件** | - |

---

## 3. 目標設定

### 3.1 データ取得目標

#### Phase 1: 主要5都府県（3ヶ月）
| 都道府県 | 目標件数 | 主要ソース |
|----------|----------|------------|
| 東京都 | 1,500件 | TOKYOはたらくネット、産業労働局、中小企業振興公社 |
| 大阪府 | 500件 | 大阪産業局、各市 |
| 愛知県 | 900件 | 愛知県産業労働部、名古屋市 |
| 神奈川県 | 700件 | 神奈川県産業労働局、横浜市 |
| 福岡県 | 500件 | 福岡県商工部、福岡市 |
| **計** | **4,100件** | - |

#### Phase 2: 準主要10府県（+3ヶ月）
- 北海道、埼玉、千葉、静岡、兵庫、京都、広島、新潟、長野、福島
- 追加 3,500件 → 累計 7,600件

#### Phase 3: 全国展開（+6ヶ月）
- 残り32県 + 市区町村
- 追加 9,400件 → 累計 17,000件

### 3.2 検索機能目標

情報の泉レベルのフィルタリング機能：
- 発行機関（省庁17機関 + その他30機関）
- 対象地域（47都道府県 + 市区町村ツリー）
- カテゴリ（7大カテゴリ + 20小カテゴリ）
- 事業者条件（業種23種 + 規模3段階 + 資本金・従業員数）
- 申請条件（電子申請・難易度・誘致・融資）

---

## 4. コスト試算

### 4.1 Firecrawlコスト試算

#### 料金体系（2025年最新）
| プラン | 月額(年払い) | クレジット | 1クレジット単価 | 同時接続 |
|--------|-------------|-----------|----------------|----------|
| Free | $0 | 500(1回) | - | 2 |
| Hobby | $16 | 3,000 | $0.0053 | 5 |
| Standard | $83 | 100,000 | $0.00083 | 50 |
| Growth | $333 | 500,000 | $0.00067 | 100 |

追加クレジット:
- Hobby: $9/1,000クレジット
- Standard: $47/35,000クレジット ($0.00134/credit)
- Growth: $177/175,000クレジット ($0.00101/credit)

#### シナリオ別コスト

**シナリオA: 全件毎日更新（非推奨）**
- 17,000件 × 30日 = 510,000クレジット/月
- コスト: Growth($333) + 追加10,000 = **約$340/月**

**シナリオB: 差分更新（推奨）**
- 初回: 17,000クレジット（1回限り）
- 日次更新:
  - 一覧ページ（変更検知）: 100ソース × 30日 = 3,000クレジット
  - 詳細ページ（変更あり）: 200件 × 30日 = 6,000クレジット
  - 新規PDF取得: 50件 × 30日 = 1,500クレジット
- 月間合計: 約10,500クレジット/月
- コスト: **Hobby($16) + 追加$72 = 約$88/月**
- または **Standard($83)** で余裕を持って運用

**シナリオC: 週次更新 + 優先度別（低コスト）**
- 優先度高（受付中2,000件）: 週2回 = 4,000件 × 4週 = 16,000クレジット
- 優先度中（公募予告5,000件）: 週1回 = 5,000件 × 4週 = 20,000クレジット
- 優先度低（終了10,000件）: 月1回 = 10,000クレジット
- 月間合計: 46,000クレジット/月
- コスト: **Standard($83)** で収まる

### 4.2 その他コスト

| 項目 | 月額 | 備考 |
|------|------|------|
| Cloudflare D1 | $5〜 | 読み取り5M+/月は$5 |
| Cloudflare Workers | $5〜 | 10M req/月まで無料 |
| R2 Storage | $0〜$15 | PDF 10GB = $1.5 |
| OCR (Google Vision) | $50〜 | 1,000ページ × $0.05 |
| AI抽出 (Claude) | $100〜 | PDF解析に使用 |

**推定月額合計: $150〜300/月**

### 4.3 コスト最適化戦略

1. **差分更新の徹底**
   - ページハッシュによる変更検知
   - Last-Modified / ETagヘッダー活用
   - 変更なしページはスキップ

2. **優先度別更新頻度**
   - 受付中: 毎日
   - 公募予告: 週2回
   - 終了: 月1回

3. **ローカルキャッシュ活用**
   - 一覧ページは1日キャッシュ
   - PDFは変更なしなら再取得しない

---

## 5. 技術設計

### 5.1 差分更新戦略

```
■ 変更検知フロー
┌─────────────────────────────────────────────────────────────┐
│  1. 一覧ページ取得（軽量）                                    │
│     ↓                                                        │
│  2. ハッシュ比較（last_hash vs 新ハッシュ）                   │
│     ├── 変更なし → スキップ                                  │
│     └── 変更あり → 3へ                                       │
│                                                              │
│  3. 詳細ページ取得（変更分のみ）                              │
│     ↓                                                        │
│  4. DB更新 + 新規PDF検出                                      │
│     ↓                                                        │
│  5. PDF取得 → OCRキューへ                                     │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 サイト構造マッピング

各自治体サイトは構造が異なるため、以下のマッピング方式を採用：

```typescript
// source_registry に追加するカラム
interface SourceMapping {
  // 一覧ページ設定
  list_url: string;              // 一覧ページURL
  list_selector: string;         // 一覧のCSSセレクタ
  pagination_type: 'page' | 'scroll' | 'api';
  pagination_selector?: string;  // ページネーションセレクタ
  
  // 詳細ページ設定
  detail_url_pattern: string;    // 詳細ページURLパターン
  title_selector: string;        // タイトルセレクタ
  deadline_selector: string;     // 締切セレクタ
  amount_selector: string;       // 金額セレクタ
  pdf_link_selector: string;     // PDFリンクセレクタ
  
  // 変更検知
  hash_target: 'body' | 'main' | 'custom';
  hash_selector?: string;        // カスタムハッシュ対象
}
```

### 5.3 東京都のマッピング例

```json
{
  "source_id": "pref-13-hataraku",
  "source_name": "TOKYOはたらくネット",
  "list_url": "https://www.hataraku.metro.tokyo.lg.jp/jinzai/",
  "list_selector": ".news-list li a",
  "pagination_type": "page",
  "pagination_selector": ".pagination a",
  "detail_url_pattern": "https://www.hataraku.metro.tokyo.lg.jp/*",
  "title_selector": "h1.page-title",
  "deadline_selector": ".deadline-date",
  "amount_selector": ".subsidy-amount",
  "pdf_link_selector": "a[href$='.pdf']",
  "hash_target": "main",
  "hash_selector": ".main-content"
}
```

### 5.4 Firecrawl連携設計

```typescript
// hojyokin-cron/src/firecrawl-client.ts
interface FirecrawlConfig {
  apiKey: string;
  baseUrl: string;
  rateLimit: number;  // req/sec
}

interface ScrapeOptions {
  url: string;
  formats: ['markdown', 'html', 'links'];
  onlyMainContent: boolean;
  waitFor?: number;
  headers?: Record<string, string>;
}

// 差分検知用
interface DiffCheckResult {
  changed: boolean;
  newHash: string;
  newLinks: string[];
  newPdfs: string[];
}
```

---

## 6. 実装フェーズ

### Phase 0: 準備（1週間）
- [ ] DB拡張マイグレーション作成
- [ ] source_registry に東京都のサブソース追加
- [ ] Firecrawl APIキー取得・設定
- [ ] 検索UI（外側）の先行実装

### Phase 1-A: 東京都実装（2週間）
- [ ] TOKYOはたらくネットのマッピング定義
- [ ] 産業労働局のマッピング定義
- [ ] 中小企業振興公社のマッピング定義
- [ ] クローラー実装・テスト
- [ ] 1,500件取得達成

### Phase 1-B: 主要4府県実装（4週間）
- [ ] 大阪府（大阪産業局）
- [ ] 愛知県（愛知県産業労働部）
- [ ] 神奈川県（神奈川県産業労働局）
- [ ] 福岡県（福岡県商工部）
- [ ] 累計5,000件達成

### Phase 2: PDF/OCR連携（並行）
- [ ] PDF取得→R2保存パイプライン
- [ ] Google Vision OCR連携
- [ ] 抽出結果のDB保存
- [ ] 申請書類テンプレート抽出

### Phase 3: 全国展開（継続）
- [ ] 残り42道府県のマッピング
- [ ] 市区町村の段階的追加
- [ ] 累計17,000件達成

---

## 7. 運用計画

### 7.1 日次運用

```
03:00 JST - hojyokin-cron 実行
  ├── source_registry のdue抽出
  ├── 変更検知（一覧ページハッシュ比較）
  ├── 変更ありソースの詳細クロール
  └── 新規PDF → OCRキューへ

06:00 JST - hojyokin-consumer 実行
  ├── OCRキュー処理
  ├── AI抽出実行
  └── extraction_results 保存

09:00 JST - 統計レポート
  ├── 新規取得件数
  ├── 変更検知件数
  ├── エラー件数
  └── コスト消費状況
```

### 7.2 監視項目

| 項目 | 閾値 | アラート |
|------|------|----------|
| クロール成功率 | < 90% | Slack通知 |
| 新規取得 0件/日 | 3日連続 | 要調査 |
| Firecrawlクレジット | < 10% | 追加購入検討 |
| D1クエリ時間 | > 1秒 | インデックス見直し |

### 7.3 マッピングメンテナンス

サイト構造変更への対応：
1. クロールエラー検知
2. セレクタ検証ツールで診断
3. マッピング定義を更新
4. 再クロール実行

---

## 8. 次のアクション

### 今日やること
1. ✅ 全体計画書の作成（本ドキュメント）
2. [ ] DB拡張マイグレーション作成（0028_crawler_mapping.sql）
3. [ ] 検索UI（詳細フィルター）の外側実装
4. [ ] Firecrawlコスト詳細確認

### 今週やること
1. [ ] 東京都のマッピング定義（3ソース）
2. [ ] Firecrawlクライアント実装
3. [ ] 差分検知ロジック実装
4. [ ] 東京都で100件テスト取得

---

**作成日**: 2026-01-23
**最終更新**: 2026-01-23
**担当**: AI Developer
