# Sprint 4: 抽出データ反映ルール表

## 概要

書類から抽出されたデータを会社プロフィールや申請書ドラフトへ反映する際の優先順位・競合解決・閾値ルールを定義します。

**Phase 2実装前提**：本ドキュメントは設計のみ。

---

## 1. 反映優先順位マトリクス

### 1-1. フィールド別優先ソース

| 反映先フィールド | 優先度1 | 優先度2 | 優先度3 | 備考 |
|-----------------|---------|---------|---------|------|
| **会社名** | 登記簿謄本 | - | - | 公的証明のみ使用 |
| **設立日** | 登記簿謄本 | - | - | 公的証明のみ使用 |
| **資本金** | 登記簿謄本 | 決算報告書 | - | 登記簿優先 |
| **所在地** | 登記簿謄本 | 賃貸借契約書 | - | 本店所在地 |
| **売上高** | 確定申告書 | 決算報告書 | - | 税務申告優先 |
| **経常利益** | 決算報告書 | - | - | 決算書のみ |
| **従業員数** | 従業員名簿 | 決算報告書 | 社会保険証明 | 直近データ優先 |
| **正社員数** | 従業員名簿 | - | - | 名簿のみ |
| **BCP認定** | BCP認定書 | - | - | 公的認定書のみ |
| **経営革新計画** | 経営革新計画承認書 | - | - | 公的承認書のみ |

### 1-2. ソース信頼度ランク

| ランク | ソース種別 | 例 |
|--------|-----------|-----|
| S | 公的機関発行・認定書 | 登記簿謄本、確定申告書、BCP認定書 |
| A | 公認会計士・税理士作成 | 監査済み決算報告書 |
| B | 社内公式書類 | 従業員名簿、組織図 |
| C | その他 | 自己申告書類 |

---

## 2. 競合解決ルール

### 2-1. 基本ルール

```
Rule 1: 同一フィールドに複数ソース → 優先度表に従う
Rule 2: 同一優先度の場合 → 直近アップロード日優先
Rule 3: 同一日付の場合 → confidence値が高い方優先
Rule 4: confidence同等の場合 → 手動選択を求める
```

### 2-2. 競合パターンと処理

| パターン | 状況 | 処理 |
|---------|------|------|
| パターンA | 新規データ、既存なし | 即時反映 |
| パターンB | 新規データ優先度 > 既存 | 上書き反映 |
| パターンC | 新規データ優先度 < 既存 | 反映せず（保存のみ） |
| パターンD | 同一優先度、新規が新しい | 上書き反映 |
| パターンE | 同一優先度、既存が新しい | 反映せず（確認待ち） |
| パターンF | 値の差異が許容範囲内 | 既存維持 |
| パターンG | 値の差異が許容範囲外 | 手動確認必須 |

### 2-3. 許容差異の定義

| フィールド | 許容差異 | 例 |
|-----------|---------|-----|
| 売上高 | 5% | 1.5億と1.52億はOK |
| 資本金 | 0% | 完全一致必須 |
| 従業員数 | 2名 | 25名と27名はOK |
| 日付 | 0日 | 完全一致必須 |

---

## 3. confidence閾値ルール

### 3-1. 閾値テーブル

| 閾値 | 判定 | UI表示 | 自動反映 |
|------|------|--------|---------|
| ≥ 0.95 | 非常に高信頼 | ✅ 確定 | ○ |
| 0.90 - 0.94 | 高信頼 | ✅ 高信頼 | ○ |
| 0.80 - 0.89 | 中高信頼 | ⚠️ 確認推奨 | ○（マーク付き） |
| 0.70 - 0.79 | 中信頼 | ⚠️ 要確認 | △（確認後） |
| 0.50 - 0.69 | 低信頼 | ❌ 低信頼 | ✗（手動のみ） |
| < 0.50 | 不信頼 | ❌ 抽出失敗 | ✗（破棄推奨） |

### 3-2. フィールド別最低閾値

重要フィールドは高い閾値を要求。

| フィールド | 最低閾値 | 理由 |
|-----------|---------|------|
| 会社名 | 0.95 | 法的に重要 |
| 設立日 | 0.90 | 要件判定に使用 |
| 資本金 | 0.90 | 要件判定に使用 |
| 売上高 | 0.85 | 要件判定に使用 |
| 従業員数 | 0.85 | 要件判定に使用 |
| BCP認定番号 | 0.90 | 加点要素 |
| 経常利益 | 0.70 | 参考情報 |

---

## 4. 反映可否判定フロー

```
┌─────────────────────────────────────────────────────────┐
│                    抽出データ受信                        │
└─────────────────────┬───────────────────────────────────┘
                      ▼
┌─────────────────────────────────────────────────────────┐
│           confidence ≥ フィールド最低閾値?               │
└─────────────────────┬───────────────┬───────────────────┘
                      │Yes            │No
                      ▼               ▼
┌─────────────────────┐   ┌─────────────────────────────┐
│   既存データあり?    │   │ 保存のみ（反映せず）         │
└─────┬─────────┬─────┘   │ → 手動確認を促す            │
      │Yes      │No       └─────────────────────────────┘
      ▼         ▼
┌─────────────┐ ┌─────────────────────────────────────────┐
│ 競合チェック │ │ 即時反映                                │
└─────┬───────┘ │ → audit_logに記録                       │
      │         └─────────────────────────────────────────┘
      ▼
┌─────────────────────────────────────────────────────────┐
│              新規データの優先度 > 既存?                   │
└─────────────────────┬───────────────┬───────────────────┘
                      │Yes            │No/同等
                      ▼               ▼
┌─────────────────────┐   ┌─────────────────────────────┐
│ 上書き反映           │   │ 差異チェック                │
│ → 変更履歴保存       │   └─────────────┬───────────────┘
└─────────────────────┘                 │
                                        ▼
                      ┌─────────────────────────────────┐
                      │         差異 ≤ 許容範囲?         │
                      └─────────────┬───────────┬───────┘
                                    │Yes        │No
                                    ▼           ▼
                      ┌─────────────┐ ┌─────────────────┐
                      │ 既存維持     │ │ 手動確認必須    │
                      │ → ログ記録   │ │ → UI通知       │
                      └─────────────┘ └─────────────────┘
```

---

## 5. 反映操作の種類

### 5-1. 操作タイプ

| 操作 | 説明 | トリガー |
|------|------|---------|
| `AUTO_APPLY` | 自動反映 | confidence高 & 競合なし |
| `AUTO_APPLY_WITH_MARK` | マーク付き自動反映 | confidence中 |
| `PENDING_REVIEW` | 確認待ち | confidence低 or 競合あり |
| `MANUAL_APPLY` | 手動反映 | ユーザー操作 |
| `MANUAL_REJECT` | 手動却下 | ユーザー操作 |
| `AUTO_SKIP` | 自動スキップ | 優先度低 & 既存あり |

### 5-2. 操作ログスキーマ

```json
{
  "operation_id": "op_abc123",
  "operation_type": "AUTO_APPLY",
  "timestamp": "2026-01-22T10:00:00Z",
  "source_document_id": "doc_xyz789",
  "source_doc_type": "financial_report",
  "target_table": "company_profile",
  "target_field": "annual_revenue",
  "previous_value": 140000000,
  "new_value": 150000000,
  "confidence": 0.95,
  "reason": "高信頼度による自動反映",
  "user_id": null,
  "reviewed_at": null
}
```

---

## 6. 申請書ドラフトへの反映

### 6-1. application_drafts への反映マッピング

| 抽出データ | ドラフトセクション | 反映テンプレート |
|-----------|-------------------|-----------------|
| 売上高 | `budget_overview` | 「売上高 ¥{revenue}（{fiscal_year}年度）」 |
| 従業員数 | `team` | 「従業員数 {employee_count}名（うち正社員{full_time}名）」 |
| 設立日 | `background` | 「{established_year}年設立（創業{years_since}年目）」 |
| BCP認定 | `team` | 「事業継続力強化計画認定済み（認定番号：{cert_number}）」 |
| 経営革新計画 | `background` | 「経営革新計画承認済み（{approval_number}）」 |

### 6-2. 反映条件

ドラフトへの反映は以下の条件を満たす場合のみ：

1. セクション内に対応するプレースホルダーがある
2. または「（未入力）」「（○○を記載）」等の未記入マーカーがある
3. confidence ≥ 0.80

---

## 7. 手動確認UI仕様

### 7-1. 確認待ちリスト

```
┌─────────────────────────────────────────────────────────┐
│ 📋 確認待ちデータ (3件)                                  │
├─────────────────────────────────────────────────────────┤
│                                                          │
│ ① 従業員数の競合                                         │
│    現在: 25名（決算報告書）                              │
│    新規: 28名（従業員名簿）★ 推奨                        │
│    [新規を採用] [既存を維持] [両方保持]                  │
│                                                          │
│ ② 売上高（低信頼度）                                    │
│    抽出値: ¥145,000,000 (confidence: 68%)               │
│    [反映する] [手動で入力] [破棄する]                    │
│                                                          │
│ ③ 経常利益（差異超過）                                  │
│    既存: ¥10,000,000                                    │
│    新規: ¥15,000,000 (差異: 50%)                        │
│    [新規を採用] [既存を維持] [確認後入力]                │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

### 7-2. 操作ボタンの動作

| ボタン | 動作 | ログ |
|--------|------|------|
| 新規を採用 | 新しい値で上書き | `MANUAL_APPLY` |
| 既存を維持 | 新しい値を破棄 | `MANUAL_REJECT` |
| 両方保持 | 履歴として両方保存 | `MANUAL_ARCHIVE` |
| 手動で入力 | 入力フォーム表示 | `MANUAL_INPUT` |
| 破棄する | 抽出データを削除 | `MANUAL_REJECT` |

---

## 8. 監査ログ要件

### 8-1. 必須記録項目

すべての反映操作は `audit_log` に記録：

```sql
INSERT INTO audit_log (
  id, user_id, action, entity_type, entity_id,
  old_value, new_value, metadata, created_at
) VALUES (
  'audit_xxx',
  'user_123',
  'PROFILE_UPDATE_FROM_EXTRACTION',
  'company_profile',
  'profile_456',
  '{"annual_revenue": 140000000}',
  '{"annual_revenue": 150000000}',
  '{"source_doc_id": "doc_789", "confidence": 0.95, "operation_type": "AUTO_APPLY"}',
  CURRENT_TIMESTAMP
);
```

### 8-2. 保持期間

| ログ種別 | 保持期間 |
|---------|---------|
| 反映操作ログ | 5年 |
| 競合解決ログ | 3年 |
| エラーログ | 1年 |

---

## 9. 設定パラメータ

### 9-1. システム設定（.env）

```env
# 自動反映の有効化
EXTRACTION_AUTO_APPLY_ENABLED=true

# 最低confidence閾値（デフォルト）
EXTRACTION_MIN_CONFIDENCE=0.70

# 高信頼度閾値（自動反映）
EXTRACTION_HIGH_CONFIDENCE=0.90

# 差異許容率（パーセント）
EXTRACTION_TOLERANCE_PERCENT=5

# 確認待ち最大保持日数
EXTRACTION_PENDING_MAX_DAYS=30
```

### 9-2. 会社別設定（オプション）

```json
{
  "company_id": "company_123",
  "extraction_settings": {
    "auto_apply_enabled": true,
    "min_confidence_override": 0.85,
    "require_manual_review": ["capital", "employee_count"],
    "notification_email": "admin@example.com"
  }
}
```

---

## 10. 実装チェックリスト（Phase 2用）

### 10-1. バックエンド

- [ ] 抽出データ受信API（`POST /api/extraction/receive`）
- [ ] 競合チェックサービス
- [ ] 自動反映ワーカー
- [ ] 手動確認キュー管理
- [ ] 監査ログ記録

### 10-2. フロントエンド

- [ ] 確認待ちリストUI
- [ ] 競合解決モーダル
- [ ] 反映履歴表示
- [ ] 設定画面

### 10-3. テスト

- [ ] 競合解決ロジックのユニットテスト
- [ ] 閾値判定のユニットテスト
- [ ] E2Eテスト（アップロード→抽出→反映）
