name: Daily Cron Jobs

on:
  schedule:
    # 毎日 03:00 JST (18:00 UTC)
    - cron: '0 18 * * *'
  workflow_dispatch:
    inputs:
      jobs:
        description: 'Comma-separated job names (sync,enrich,fallback,recalc,tokyo)'
        required: false
        default: 'sync,enrich,fallback,recalc'

env:
  API_BASE: https://hojyokin.pages.dev/api/cron

jobs:
  sync-jgrants:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Sync JGrants
        if: >-
          github.event_name == 'schedule' || 
          contains(github.event.inputs.jobs, 'sync')
        run: |
          echo "=== sync-jgrants ==="
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "${{ env.API_BASE }}/sync-jgrants" \
            -H "X-Cron-Secret: ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            --max-time 60)
          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | head -n -1)
          echo "HTTP: $HTTP_CODE"
          echo "$BODY" | python3 -c "import sys,json; d=json.load(sys.stdin); print(json.dumps(d, indent=2))" 2>/dev/null || echo "$BODY"
          if [ "$HTTP_CODE" != "200" ]; then
            echo "::error::sync-jgrants failed with HTTP $HTTP_CODE"
            exit 1
          fi

  enrich-jgrants:
    needs: sync-jgrants
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Enrich JGrants (30 batches x 5 items)
        if: >-
          github.event_name == 'schedule' || 
          contains(github.event.inputs.jobs, 'enrich')
        run: |
          echo "=== enrich-jgrants (30 batches) ==="
          TOTAL_ENRICHED=0
          TOTAL_READY=0
          for i in $(seq 1 30); do
            RESPONSE=$(curl -s -X POST "${{ env.API_BASE }}/enrich-jgrants" \
              -H "X-Cron-Secret: ${{ secrets.CRON_SECRET }}" \
              -H "Content-Type: application/json" \
              --max-time 30 2>/dev/null)
            ENRICHED=$(echo "$RESPONSE" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d['data']['items_enriched'])" 2>/dev/null || echo "0")
            READY=$(echo "$RESPONSE" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d['data']['items_ready'])" 2>/dev/null || echo "0")
            TOTAL_ENRICHED=$((TOTAL_ENRICHED + ENRICHED))
            TOTAL_READY=$((TOTAL_READY + READY))
            # 0件処理なら終了
            if [ "$ENRICHED" = "0" ]; then
              echo "No more items to enrich at batch $i. Done."
              break
            fi
            sleep 2
          done
          echo "Total: enriched=$TOTAL_ENRICHED, ready=$TOTAL_READY"

  apply-fallbacks:
    needs: enrich-jgrants
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Apply Field Fallbacks
        if: >-
          github.event_name == 'schedule' || 
          contains(github.event.inputs.jobs, 'fallback')
        run: |
          echo "=== apply-field-fallbacks ==="
          curl -s -X POST "${{ env.API_BASE }}/apply-field-fallbacks" \
            -H "X-Cron-Secret: ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            --max-time 30 | python3 -c "import sys,json; d=json.load(sys.stdin); print(json.dumps(d, indent=2))" 2>/dev/null

  recalc-wall-chat:
    needs: apply-fallbacks
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Recalc Wall Chat Ready (full scan)
        if: >-
          github.event_name == 'schedule' || 
          contains(github.event.inputs.jobs, 'recalc')
        run: |
          echo "=== recalc-wall-chat-ready (full scan) ==="
          TOTAL_PROCESSED=0
          for i in $(seq 1 35); do
            RESPONSE=$(curl -s -X POST "${{ env.API_BASE }}/recalc-wall-chat-ready" \
              -H "X-Cron-Secret: ${{ secrets.CRON_SECRET }}" \
              -H "Content-Type: application/json" \
              --max-time 30 2>/dev/null)
            PROCESSED=$(echo "$RESPONSE" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d['data']['items_processed'])" 2>/dev/null || echo "0")
            TOTAL_PROCESSED=$((TOTAL_PROCESSED + PROCESSED))
            if [ "$PROCESSED" = "0" ]; then
              echo "Scan complete at batch $i."
              break
            fi
            sleep 1
          done
          echo "Total processed: $TOTAL_PROCESSED"

  scrape-tokyo:
    needs: sync-jgrants
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: >-
      github.event_name == 'schedule' || 
      contains(github.event.inputs.jobs, 'tokyo')
    steps:
      - name: Scrape Tokyo Kosha
        run: |
          curl -s -X POST "${{ env.API_BASE }}/scrape-tokyo-kosha" \
            -H "X-Cron-Secret: ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            --max-time 60 | python3 -c "import sys,json; d=json.load(sys.stdin); print(json.dumps(d, indent=2))" 2>/dev/null
      
      - name: Scrape Tokyo Shigoto
        run: |
          curl -s -X POST "${{ env.API_BASE }}/scrape-tokyo-shigoto" \
            -H "X-Cron-Secret: ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            --max-time 60 | python3 -c "import sys,json; d=json.load(sys.stdin); print(json.dumps(d, indent=2))" 2>/dev/null

      - name: Scrape Tokyo Hataraku
        run: |
          curl -s -X POST "${{ env.API_BASE }}/scrape-tokyo-hataraku" \
            -H "X-Cron-Secret: ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            --max-time 60 | python3 -c "import sys,json; d=json.load(sys.stdin); print(json.dumps(d, indent=2))" 2>/dev/null

  health-check:
    needs: [recalc-wall-chat, scrape-tokyo]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - name: Health Check
        run: |
          echo "=== Final Health Check ==="
          curl -s "https://hojyokin.pages.dev/api/health" | \
            python3 -c "import sys,json; d=json.load(sys.stdin); print(json.dumps(d, indent=2))" 2>/dev/null
          echo ""
          echo "=== Cron Health ==="
          curl -s "https://hojyokin.pages.dev/api/cron/health" | \
            python3 -c "import sys,json; d=json.load(sys.stdin); print(json.dumps(d, indent=2))" 2>/dev/null
